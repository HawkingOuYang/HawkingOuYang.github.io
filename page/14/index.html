<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="HawkingOuYang, iOS developer, Tech. Memo">





  <link rel="alternate" href="/atom.xml" title="Tech. Memo" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/img/ico1.ico?v=5.0.1">






<meta name="description" content="WeApp Web iOS">
<meta property="og:type" content="website">
<meta property="og:title" content="Tech. Memo">
<meta property="og:url" content="https://HawkingOuYang.github.io/page/14/index.html">
<meta property="og:site_name" content="Tech. Memo">
<meta property="og:description" content="WeApp Web iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tech. Memo">
<meta name="twitter:description" content="WeApp Web iOS">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="https://HawkingOuYang.github.io/page/14/">

  <title> Tech. Memo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?88ba182830f261362f8368804c0b8a56";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Tech. Memo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">stay hungry, stay foolish.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/21/10_iOS-CoreData-MultiThreading-FactoryPattern-Singleton/" itemprop="url">
                  CoreData + 多线程 + 工厂模式 + 单例模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-21T00:00:00+08:00" content="2016-09-21">
              2016-09-21
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/21/10_iOS-CoreData-MultiThreading-FactoryPattern-Singleton/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/21/10_iOS-CoreData-MultiThreading-FactoryPattern-Singleton/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>文章出处，原创于 <a href="https://HawkingOuYang.github.io/">https://HawkingOuYang.github.io/</a></p>
<p><a href="https://github.com/HawkingOuYang/" target="_blank" rel="external">我的GitHub</a></p>
<hr>
<p>&copy; OYXJ </p>
<h5 id="并发编程：API-及挑战"><a href="#并发编程：API-及挑战" class="headerlink" title="并发编程：API 及挑战"></a><a href="https://objccn.io/issue-2-1/" target="_blank" rel="external">并发编程：API 及挑战</a></h5><p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_0_StoryBegin1.png" alt=""><br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_0_StoryBegin2.png" alt=""><br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_0_StoryBegin3.png" alt=""></p>
<h5 id="Core-Data-Lightweight-Migration"><a href="#Core-Data-Lightweight-Migration" class="headerlink" title="Core Data Lightweight Migration"></a>Core Data Lightweight Migration</h5><p>Ref：</p>
<p>（1）<a href="http://www.objc.io/issue-4/core-data-migration.html" target="_blank" rel="external">http://www.objc.io/issue-4/core-data-migration.html</a></p>
<p>（2）<a href="http://stackoverflow.com/questions/1830079/iphone-core-data-automatic-lightweight-migration" target="_blank" rel="external">http://stackoverflow.com/questions/1830079/iphone-core-data-automatic-lightweight-migration</a> (这个好，具体到步骤)</p>
<p>（3）<a href="http://www.raywenderlich.com/86136/lightweight-migrations-core-data-tutorial" target="_blank" rel="external">http://www.raywenderlich.com/86136/lightweight-migrations-core-data-tutorial</a></p>
<p>（4）<a href="http://www.raywenderlich.com/27657/how-to-perform-a-lightweight-core-data-migration" target="_blank" rel="external">http://www.raywenderlich.com/27657/how-to-perform-a-lightweight-core-data-migration</a></p>
<p>（5）<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreDataVersioning/Articles/vmLightweightMigration.html" target="_blank" rel="external">https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreDataVersioning/Articles/vmLightweightMigration.html</a></p>
<p>（6）<a href="http://stackoverflow.com/questions/13897348/managed-object-in-core-data-entity-causing-is-not-key-value-coding-compliant-fo" target="_blank" rel="external">http://stackoverflow.com/questions/13897348/managed-object-in-core-data-entity-causing-is-not-key-value-coding-compliant-fo</a></p>
<p>（7）<a href="http://stackoverflow.com/questions/2730832/how-can-i-duplicate-or-copy-a-core-data-managed-object" target="_blank" rel="external">http://stackoverflow.com/questions/2730832/how-can-i-duplicate-or-copy-a-core-data-managed-object</a></p>
<p>（8）<a href="http://stackoverflow.com/questions/3256195/how-to-deal-with-temporary-nsmanagedobject-instances" target="_blank" rel="external">http://stackoverflow.com/questions/3256195/how-to-deal-with-temporary-nsmanagedobject-instances</a></p>
<h5 id="CoreData数据库轻量迁移"><a href="#CoreData数据库轻量迁移" class="headerlink" title="CoreData数据库轻量迁移"></a>CoreData数据库轻量迁移</h5><p>CoreData数据库轻量迁移，针对于同一个iOSApp在版本升级(更新安装App)的过程中，需要注意的数据库迁移；如果不进行数据库迁移，则会导致，覆盖安装闪退。这里说的数据库迁移，特指：CoreData轻量数据库迁移。</p>
<p>CoreData轻量数据库迁移，具体步骤如下：</p>
<p>iPhone Core Data “Automatic Lightweight Migration”</p>
<p><a href="http://stackoverflow.com/questions/1830079/iphone-core-data-automatic-lightweight-migration" target="_blank" rel="external">http://stackoverflow.com/questions/1830079/iphone-core-data-automatic-lightweight-migration</a></p>
<p>To recap/Full guide:</p>
<p>1、 Before making any change, create a new model version.</p>
<p>In Xcode 4: Select your .xcdatamodel –&gt;&gt; Editor –&gt;&gt; Add Model Version.</p>
<p>In Xcode 3: Design –&gt;&gt; Data Model –&gt;&gt; Add Model Version.</p>
<p>You will see that a new .xcdatamodel is created in your .xcdatamodeld folder (which is also created if you have none).</p>
<p>2、    Save.</p>
<p>3、    Select your new .xcdatamodel and make the change you wish to employ in accordance withthe Lightweight Migration documentation.</p>
<p>4、 Save.</p>
<p>5、    Set the current/active schema to the newly created schema.</p>
<p>With the .xcdatamodeld folder selected:</p>
<p>In Xcode 4: Utilities sidebar –&gt;&gt; File Inspector –&gt;&gt; Versioned Core Data Model –&gt;&gt; Select the new schema.</p>
<p>In Xcode 3: Design –&gt;&gt; Data Model –&gt;&gt; Set Current Version.</p>
<p>The green tick on the .xcdatamodel icon will move to the new schema.</p>
<p>6、    Save.</p>
<p>7、    Implement the necessary code to perform migration at runtime.</p>
<p>Where your NSPersistentStoreCoordinator is created (usually AppDelegate class), for the options parameter, replace nil with the following code:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[NSDictionary dictionaryWithObjectsAndKeys:</div><div class="line">[NSNumber numberWithBool:YES], NSMigratePersistentStoresAutomaticallyOption,</div><div class="line">[NSNumber numberWithBool:YES], NSInferMappingModelAutomaticallyOption, nil]</div></pre></td></tr></table></figure>
<p>8、    Run your app. If there’s no crash, you’ve probably successfully migrated :)</p>
<p>9、    When you have successfully migrated, the migration code (step 7) can be removed. (It is up to the developer to determine when the users of a published app can be deemed to have migrated.)</p>
<p><strong>IMPORTANT</strong>: Do not delete old model versions/schemas. Core Data needs the old version to migrate to the new version.</p>
<p>中文如下：</p>
<p>1、选中DB.xcdatamodeld  (对，那个绿色钩)<br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-migration_1.jpg" alt=""></p>
<p>2、Xcode工具栏中，Editor —&gt; Add Model Version<br>特别注意：先备份，再更改数据库。<br> v0.6.0_20150828_01.xcdatamodel<br>   其中：v0.6.0 —&gt; 数据库版本号<br>               20150828 —&gt; 日期,即哪天改动的。<br>               01 —&gt; 上面这个日期的第几次更改数据<br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-migration_2.jpg" alt=""></p>
<p> 表结构<br>    一般来说：<br>    数据表schema 由iOS开发组的一个成员来维护，以便减少 数据表schema 更改的次数。<br>    特别来说：<br>    对于已经上架AppStore的版本，一定要做好CoreData的数据迁移，否则在覆盖安装之后，app重新launch(启动)的时候，会闪退。</p>
<p>3、更改表结构，即编辑DB.xcdatamodeld文件。</p>
<p>特别说明：</p>
<p>如果 跳过第二步：2、Xcode工具栏中，Editor —&gt; Add Model Version<br>直接到第三部：3、更改表结构，即编辑DB.xcdatamodeld文件。<br>已经导致：覆盖安装崩溃。</p>
<p>补救方法如下：</p>
<p>1、不管你是用Git还是SVN，回到你更改数据库之前的一个时间点(代码的snapshot)，在那个时候备份数据模型文件(即对DB.xcdatamodeld 增加Model Version)。<br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-migration_3.jpg" alt=""></p>
<p>2、把这个增加的Model Version，添加到现在的DB.xcdatamodeld中。<br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-migration_4.jpg" alt=""></p>
<p>测试验证：覆盖安装，不崩溃。</p>
<h5 id="CoreData使用参考"><a href="#CoreData使用参考" class="headerlink" title="CoreData使用参考"></a>CoreData使用参考</h5><p><a href="http://blog.csdn.net/kesalin/article/details/6739319" target="_blank" rel="external">深入浅出 Cocoa 之 Core Data（1）- 框架详解</a></p>
<p><a href="http://blog.csdn.net/ryantang03/article/details/7794226" target="_blank" rel="external">IOS学习笔记16——Core Data</a></p>
<p><a href="http://blog.csdn.net/xiaowenwen1010/article/details/39534303" target="_blank" rel="external">iOS Coredata安全之多线程</a></p>
<p><a href="http://blog.csdn.net/a2657222/article/details/7551435" target="_blank" rel="external">iphone开发之数据库CoreData</a></p>
<p><a href="http://www.oschina.net/news/49051/core-data-10-errors" target="_blank" rel="external">iOS 开发中使用 Core Data 应避免的十个错误</a></p>
<p><a href="http://www.cnblogs.com/xiaodao/archive/2012/10/08/2715477.html" target="_blank" rel="external">iphone数据存储之－－ Core Data的使用（一）</a></p>
<p><a href="http://itjoy.org/?p=446" target="_blank" rel="external">IOS数据持久化–Core Data(一)</a></p>
<h5 id="CoreData使用特别注意"><a href="#CoreData使用特别注意" class="headerlink" title="CoreData使用特别注意"></a>CoreData使用特别注意</h5><p>1、每个NSThread实例，必须有各自的NSManagedObjectContext实例，该Context实际上是把db.sqlite文件读取到内存中(使用<strong>fault</strong>这种内存策略，建立索引，以减小内存占用)。</p>
<p>2、CoreData的数据库实体（即 Entity，继承自NSManagedObject），存在于各自所属NSThread实例的NSManagedObjectContext实例中，并且Entity <strong>不能</strong> 跨线程传递；如果 一定要 <strong>跨线程</strong> 传递Entity，请传递该Entity的主键(比如 myEntity.entityUUID)，然后在 <strong>另一个线程</strong> 使用 myEntity.entityUUID 从这个所谓 <strong>另一个线程</strong>  的Context，查找到这个Entity。</p>
<p>3、临时Entity数据，即 不打算 持久化的Entity，请使用 临时的Context，并且一定不能 [临时Context save]</p>
<p>4、Entity深拷贝？上面有代码。</p>
<p>5、CoreData 数据库迁移？CoreData 关系建立与移除？上面链接有。</p>
<h5 id="CoreData多线程数据合并、多线程数据同步"><a href="#CoreData多线程数据合并、多线程数据同步" class="headerlink" title="CoreData多线程数据合并、多线程数据同步"></a>CoreData多线程数据合并、多线程数据同步</h5><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"><span class="type">Updates</span> the persistent properties <span class="keyword">of</span> a managed <span class="keyword">object</span> to use the latest values <span class="keyword">from</span> the persistent store.</div><div class="line">                 </div><div class="line"><span class="type">If</span> flag <span class="keyword">is</span> <span class="type">YES</span>, this <span class="keyword">method</span> does <span class="keyword">not</span> affect <span class="built_in">any</span> transient properties; <span class="keyword">if</span> flag <span class="keyword">is</span> <span class="type">NO</span>, transient properties are disposed <span class="keyword">of</span>.</div><div class="line">*/</div><div class="line">[self refreshObject:obj mergeChanges:<span class="type">YES</span>];//参数<span class="type">YES</span></div></pre></td></tr></table></figure>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-MultiThreadDataMerge.png" alt=""></p>
<h5 id="业务管理类的抽象基类"><a href="#业务管理类的抽象基类" class="headerlink" title="业务管理类的抽象基类"></a>业务管理类的抽象基类</h5><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/* .h */</span></div><div class="line"></div><div class="line"><span class="comment">/*! @brief 业务管理类 的抽象基类</span></div><div class="line"> *  @author modify by OYXJ</div><div class="line"> */</div><div class="line"><span class="variable">@interface</span> <span class="attribute">AbstractManager </span>: NSObject</div><div class="line"><span class="comment">/**</span></div><div class="line"> *  @note 相信我，｀operationQueue｀ 不会为 nil 。</div><div class="line"> *  @attention 特别地，使用当前 `操作队列`， 进行 ｀读取、写入(特别注意写入) CoreData数据库的操作｀。</div><div class="line"> *  @see BusinessBlockOperation</div><div class="line"> *  @see BusinessSelectorOperation</div><div class="line"> *  @see 文档：`CoreData + 多线程 + 工厂模式 + 单例模式`</div><div class="line"> */</div><div class="line"><span class="variable">@property</span> (weak,readonly) CustomOperationQueue *operationQueue;</div></pre></td></tr></table></figure>
<h5 id="自定义操作（基于：Block）"><a href="#自定义操作（基于：Block）" class="headerlink" title="自定义操作（基于：Block）"></a>自定义操作（基于：Block）</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/* .h */</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 自定义操作（基于：Block），说明 by OYXJ on 2016.08.30</div><div class="line"> </div><div class="line"> <span class="doctag">@note</span> 当前类依赖于这个方法：</div><div class="line">    ｀</div><div class="line">        合并数据</div><div class="line">        合并对象：调用这个方法后，当前线程上下文将合并其它线程有更改的对象。</div><div class="line">        此函数一般用在运行时间比较长的线程，比如循环比较多的线程。</div><div class="line">        [[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];</div><div class="line">    ｀</div><div class="line"> </div><div class="line"> <span class="doctag">@attention</span> 特别地，使用当前类处理 ｀读取、写入(特别注意写入) CoreData数据库的操作｀，因为：</div><div class="line">    ｀</div><div class="line">        当前类 在执行 block 之前，</div><div class="line">        会调用 [[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread]; </div><div class="line">        从而 使得多个线程之间 的数据完成同步。</div><div class="line">    ｀</div><div class="line"> */</div><div class="line"><span class="meta">@interface</span> <span class="string">BusinessBlockOperation :</span> NSOperation</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  ARC, block will be copied</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@param</span> block  block will be copied by `the returned object of current method`</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@return</span> an initialized instance of current class.</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@attention</span> please add the return `operation object` to an operation queue.</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@attention</span> Specially，be sure that `block` will be executed synchronously.</div><div class="line"> *  <span class="doctag">@attention</span> 特别注意：请确保 ｀block｀ 将会 同步执行的。</div><div class="line"> *  <span class="doctag">@attention</span> 特别地，使用当前类处理 ｀读取、写入(特别注意写入) CoreData数据库的操作｀。</div><div class="line"> */</div><div class="line">+ (nullable instancetype)<span class="string">blockOperationWithBlock:</span>(<span class="keyword">void</span> (^ _Nonnull)(<span class="keyword">void</span>))block;</div><div class="line"></div><div class="line"><span class="meta">@end</span></div></pre></td></tr></table></figure>
<h5 id="自定义操作（基于：Selector）"><a href="#自定义操作（基于：Selector）" class="headerlink" title="自定义操作（基于：Selector）"></a>自定义操作（基于：Selector）</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/* .h */</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 自定义操作（基于：Selector），说明 by OYXJ on 2016.08.30</div><div class="line"> </div><div class="line"> <span class="doctag">@note</span> 当前类依赖于这个方法：</div><div class="line">    ｀</div><div class="line">        合并数据</div><div class="line">        合并对象：调用这个方法后，当前线程上下文将合并其它线程有更改的对象。</div><div class="line">        此函数一般用在运行时间比较长的线程，比如循环比较多的线程。</div><div class="line">        [[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];</div><div class="line">    ｀</div><div class="line"> </div><div class="line"> <span class="doctag">@attention</span> 特别地，使用当前类处理 ｀读取、写入(特别注意写入) CoreData数据库的操作｀，因为：</div><div class="line">    ｀</div><div class="line">        当前类 在执行 target的sel方法 之前，</div><div class="line">        会调用 [[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread]; </div><div class="line">        从而 使得多个线程之间 的数据完成同步。</div><div class="line">    ｀</div><div class="line"> */</div><div class="line"><span class="meta">@interface</span> <span class="string">BusinessSelectorOperation :</span> NSOperation</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  ARC, strong reference to param objs</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@param</span> target strong referenced by `the returned object of current method`</div><div class="line"> *  <span class="doctag">@param</span> sel    not referenced by `the returned object of current method`</div><div class="line"> *  <span class="doctag">@param</span> arg    strong referenced by `the returned object of current method`, can be nil</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@return</span> an initialized instance of current class.</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@attention</span> please add the return `operation object` to an operation queue.</div><div class="line"> *</div><div class="line"> *  <span class="doctag">@attention</span> Specially，be sure that `sel` will be executed synchronously.</div><div class="line"> *  <span class="doctag">@attention</span> 特别注意：请确保 ｀sel｀ 将会 同步执行的。</div><div class="line"> *  <span class="doctag">@attention</span> 特别地，使用当前类处理 ｀读取、写入(特别注意写入) CoreData数据库的操作｀。</div><div class="line"> */</div><div class="line">- (nullable instancetype)<span class="string">initWithTarget:</span>(id _Nonnull __strong)target</div><div class="line"><span class="symbol">                               selector:</span>(SEL _Nonnull)sel</div><div class="line"><span class="symbol">                                 object:</span>(id _Nullable __strong)arg;</div><div class="line"><span class="meta">@end</span></div></pre></td></tr></table></figure>
<h5 id="自定义操作队列"><a href="#自定义操作队列" class="headerlink" title="自定义操作队列"></a>自定义操作队列</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/* .h */</span></div><div class="line"></div><div class="line"><span class="comment">//! 自定义操作队列</span></div><div class="line"><span class="meta">@interface</span> <span class="string">CustomOperationQueue :</span> NSOperationQueue</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> <span class="doctag">@note</span> 单例</div><div class="line"> <span class="doctag">@attention</span> 特别地，使用当前类处理 ｀读取、写入(特别注意写入) CoreData数据库的操作｀，</div><div class="line">            因为：CoreData 多线程，线程之间数据的同步，多个线程上下文的性能。</div><div class="line"> */</div><div class="line">+ (CustomOperationQueue *)sharedCustomOperationQueue;</div></pre></td></tr></table></figure>
<h5 id="举个🌰-栗子-li-zi-for-example"><a href="#举个🌰-栗子-li-zi-for-example" class="headerlink" title="举个🌰(栗子 li zi ) for example"></a>举个🌰(栗子 li zi ) for example</h5><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">#import</span> &lt;CAbstractManager/<span class="keyword">BusinessBlockOperation.h&gt; </span>//<span class="keyword">block写数据库(CoreData)</span></div><div class="line"></div><div class="line">//! 在后台线程，将所有 从服务端抓取的通话记录 保存到本地数据库中</div><div class="line"><span class="keyword">BusinessBlockOperation </span>*<span class="keyword">bOP </span>= [<span class="keyword">BusinessBlockOperation </span><span class="keyword">blockOperationWithBlock:^&#123;</span></div><div class="line">	// 将所有 从服务端抓取的通话记录 保存到本地数据库中</div><div class="line">	[[[<span class="keyword">BusinessManager </span>sharedManager] callRecordManager] saveCallRecordsThatFetchedFromServerAsDic:aDic]<span class="comment">;</span></div><div class="line">&#125;]<span class="comment">;</span></div><div class="line">// 将所有 从服务端抓取的通话记录 保存到本地数据库中</div><div class="line">[[[<span class="keyword">BusinessManager </span>sharedManager] callRecordManager].operationQueue <span class="keyword">addOperation:bOP];</span></div></pre></td></tr></table></figure>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_1.png" alt="iOS-CoreData-MultiThreading-FactoryPattern-Singleton_1"></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_2.png" alt="iOS-CoreData-MultiThreading-FactoryPattern-Singleton_2"></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_3.png" alt="iOS-CoreData-MultiThreading-FactoryPattern-Singleton_3"></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_4.png" alt="iOS-CoreData-MultiThreading-FactoryPattern-Singleton_4"></p>
<h6 id="栗子-1"><a href="#栗子-1" class="headerlink" title="栗子 1"></a>栗子 1</h6><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">//试点<span class="number">1</span>：写入数据库</div><div class="line"></div><div class="line">#import &lt;<span class="symbol">CAbstractManager</span>/<span class="symbol">BusinessBlockOperation</span>.h&gt; //block写数据库(<span class="symbol">CoreData</span>)</div><div class="line"></div><div class="line">dispatch_async(dispatch_get_global_queue(<span class="symbol">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>), ^&#123;</div><div class="line">	//! 在后台线程，将所有 从服务端抓取的通话记录 保存到本地数据库中</div><div class="line">	[[[<span class="symbol">BusinessManager</span> sharedManager] callRecordManager] saveCallRecordsThatFetchedFromServerAsDic:aDic];</div><div class="line">&#125;);</div><div class="line"></div><div class="line">//改成：</div><div class="line"></div><div class="line">//! 在自定义操作队列：将所有 从服务端抓取的通话记录 保存到本地数据库<span class="symbol">CoreData</span>中</div><div class="line"><span class="symbol">BusinessBlockOperation</span> *bOP = [<span class="symbol">BusinessBlockOperation</span> blockOperationWithBlock:^&#123;</div><div class="line">	<span class="comment">/*</span></div><div class="line">	特别注意：请确保 读写CoreData数据库的 ｀block｀ 将会 同步执行的。</div><div class="line">	*/</div><div class="line">	// 将所有 从服务端抓取的通话记录 保存到本地数据库<span class="symbol">CoreData</span>中</div><div class="line">	[[[<span class="symbol">BusinessManager</span> sharedManager] callRecordManager] saveCallRecordsThatFetchedFromServerAsDic:aDic];</div><div class="line">&#125;];</div><div class="line">// 将所有 从服务端抓取的通话记录 保存到本地数据库<span class="symbol">CoreData</span>中</div><div class="line">[[[<span class="symbol">BusinessManager</span> sharedManager] callRecordManager].operationQueue addOperation:bOP];</div></pre></td></tr></table></figure>
<h6 id="栗子-2"><a href="#栗子-2" class="headerlink" title="栗子 2"></a>栗子 2</h6><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//试点2：网络请求，回调 写入数据库</span></div><div class="line"></div><div class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 读写 本地数据库CoreData</span></div><div class="line">	HTmAccountEntity *currentAccountEntity = [[[BusinessManager sharedManager] systemAccountManager] currentLoginSystemAccount];</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (currentAccountEntity.portraitURL.length &gt; <span class="number">0</span>) &#123;<span class="comment">// 获取网络头像URL</span></div><div class="line">		</div><div class="line">		<span class="comment">// `逻辑层` 传递参数到 `网络层`，使用 字典(易于扩展) 或者 数据模型(编写时、编译时 有类型检查)，我选“字典”。</span></div><div class="line">	    NSDictionary *dic = @&#123;@<span class="string">"URLString"</span> : aPortraitURL?:@<span class="string">""</span>   ,   	  <span class="comment">//头像图片 URL地址</span></div><div class="line">                            @<span class="string">"fileAbsolutePath"</span> : tmp_aFileAbsolutePath?:@<span class="string">""</span>  <span class="comment">//头像图片 绝对路径，下载之后保存在本地的路径(临时文件)</span></div><div class="line">                            &#125;;</div><div class="line">	</div><div class="line">		<span class="comment">// processor属于｀处理层｀(捕获异常 放在 `网络层` 做吧)，可以 同步 或者 异步，看具体业务啦~</span></div><div class="line">		[processor <span class="string">requestService_query_portraitInfo:</span>dic <span class="string">success:</span>^(NSDictionary *serverResponse) &#123;</div><div class="line">                </div><div class="line">		    <span class="comment">/*</span></div><div class="line">		    注意：如果此处，要 读写CoreData数据库，那么取消注释 此代码。</div><div class="line">		    // 合并对象：调用这个方法后，当前线程上下文将合并其它线程有更改的对象。</div><div class="line">		    [[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];</div><div class="line">		    */</div><div class="line">	</div><div class="line">		    <span class="comment">// handle success</span></div><div class="line">		    <span class="comment">// DDLogVerbose (Debug时用)</span></div><div class="line"></div><div class="line">	    &#125;<span class="string">failure:</span>^(NSDictionary *errorDic) &#123;</div><div class="line">	    </div><div class="line">			<span class="comment">// handle error</span></div><div class="line">			<span class="comment">//  DDLogError (Debug/Release时用，然后 `反馈日志` 定时上传)</span></div><div class="line">	    &#125;];</div><div class="line"></div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line"></div><div class="line">		dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">			<span class="keyword">if</span> (failure) &#123;</div><div class="line">				<span class="comment">//人为构造 errorDic：获取网络头像URL为nil</span></div><div class="line">	            failure(errorDic); <span class="comment">// <span class="doctag">TODO:</span> errorDic</span></div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//改成：</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//! 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">BusinessBlockOperation *bOP = [BusinessBlockOperation <span class="string">blockOperationWithBlock:</span>^&#123;</div><div class="line">       </div><div class="line">	<span class="comment">// processor属于｀处理层｀(捕获异常 放在 `网络层` 做吧)，可以 同步 或者 异步，看具体业务啦~</span></div><div class="line">	[processor <span class="string">requestService_query_portraitInfo:</span>dic <span class="string">success:</span>^(NSDictionary *serverResponse) &#123;</div><div class="line">	</div><div class="line">        <span class="comment">//! 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">        BusinessBlockOperation *blockOP = [BusinessBlockOperation <span class="string">blockOperationWithBlock:</span>^&#123;</div><div class="line">	        <span class="comment">/*</span></div><div class="line">	        特别注意：请确保 读写CoreData数据库的 ｀block｀ 将会 同步执行的。</div><div class="line">	        */</div><div class="line">	        <span class="keyword">if</span> ([serverResponse[@<span class="string">"ResultCode"</span>] <span class="string">isEqualToString:</span>@<span class="string">"0"</span>]) <span class="comment">//此App中，所有网络请求成功statusCode用字符串@"0"，要不要 使用数据模型呢？用起来好一些，后期再优化，独立开发App，时间来不及了。</span></div><div class="line">	        &#123;<span class="comment">//&lt;-- 解析数据 begin--&gt;//</span></div><div class="line">        </div><div class="line">	            NSDictionary *responseObject = serverResponse[@<span class="string">"ResponseObject"</span>];<span class="comment">//此App中，所有网络请求成功response数据用字典KEY为@"ResponseObject"，要不要 使用数据模型呢？用起来好一些，后期再优化，独立开发App，时间来不及了。</span></div><div class="line">            </div><div class="line">	            HTmAccountEntity *curAccountEntity = [[[BusinessManager sharedManager] systemAccountManager] currentLoginSystemAccount];</div><div class="line">	            <span class="comment">//! 更新 头像图片的 本地相对路径</span></div><div class="line">	            curAccountEntity.portraitPath = [fileAbsolutePath lastPathComponent];</div><div class="line">	            [accessor save]; <span class="comment">/* 每个业务管理Manager有个 accessor (数据存取器)*/</span></div><div class="line">                        </div><div class="line">	        &#125;<span class="comment">//&lt;-- 解析数据 end--&gt;//</span></div><div class="line">        </div><div class="line">	        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">		        <span class="keyword">if</span> (success) &#123;</div><div class="line">					success(serverResponse);</div><div class="line">		        &#125;</div><div class="line">            &#125;);<span class="comment">// &lt;-- dispatch async -- main queue --&gt; //</span></div><div class="line">        &#125;];<span class="comment">//&lt;— 在自定义操作队列：读写 本地数据库CoreData —&gt;//                </span></div><div class="line">    </div><div class="line">        <span class="comment">// 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">        [[[BusinessManager sharedManager] systemAccountManager].operationQueue <span class="string">addOperation:</span>blockOP];</div><div class="line">                </div><div class="line"></div><div class="line">    &#125; <span class="string">failure:</span>^(NSDictionary *errorDic) &#123;</div><div class="line">                    </div><div class="line">                    </div><div class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">            <span class="keyword">if</span> (failure) &#123;</div><div class="line">                failure(errorDic);</div><div class="line">            &#125;</div><div class="line">        &#125;);<span class="comment">// &lt;-- dispatch async -- main queue --&gt; //</span></div><div class="line">                    </div><div class="line">    &#125;];</div><div class="line"></div><div class="line">&#125;];<span class="comment">// &lt;-- 在自定义操作队列：读写 本地数据库CoreData --&gt; //</span></div><div class="line">    </div><div class="line"><span class="comment">// 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">[[[BusinessManager sharedManager] systemAccountManager].operationQueue <span class="string">addOperation:</span>bOP];</div></pre></td></tr></table></figure>
<p>这个例子好长，来，看两张美图，放松一下😌。</p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_5.png" alt="iOS-CoreData-MultiThreading-FactoryPattern-Singleton_5"></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_6.png" alt="iOS-CoreData-MultiThreading-FactoryPattern-Singleton_6"></p>
<h6 id="栗子-3"><a href="#栗子-3" class="headerlink" title="栗子 3"></a>栗子 3</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;CAbstractManager/BusinessBlockOperation.h&gt;</span> //block写数据库(CoreData)</span></div><div class="line"></div><div class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">	<span class="comment">// 合并对象：调用这个方法后，当前线程上下文将合并其它线程有更改的对象。</span></div><div class="line">	[[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];  </div><div class="line">	</div><div class="line">	<span class="comment">/*</span></div><div class="line">	特别注意：请确保 读写CoreData数据库的 ｀block｀ 将会 同步执行的。</div><div class="line">	*/</div><div class="line"></div><div class="line">	<span class="comment">// do something here ....</span></div><div class="line"></div><div class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">		<span class="keyword">if</span> (success) &#123;</div><div class="line">			success(responseDic);</div><div class="line">		&#125;</div><div class="line">	&#125;);<span class="comment">// &lt;-- dispatch async -- main queue --&gt; //</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 改成：</span></div><div class="line"></div><div class="line"><span class="comment">//! 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">BusinessBlockOperation *bOP = [BusinessBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 特别注意：请确保 读写CoreData数据库的 ｀block｀ 将会 同步执行的。</div><div class="line">	*/</div><div class="line"></div><div class="line">	<span class="comment">// do something here ...</span></div><div class="line"></div><div class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">		<span class="keyword">if</span> (success) &#123;</div><div class="line">			success(responseDic);</div><div class="line">		&#125;</div><div class="line">	&#125;);<span class="comment">// &lt;-- dispatch async -- main queue --&gt; //</span></div><div class="line">&#125;];</div><div class="line"><span class="comment">// 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">[[[BusinessManager sharedManager] systemAccountManager].operationQueue addOperation:bOP];</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 从 </span></div><div class="line"></div><div class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 特别注意：请确保 读写CoreData数据库的 ｀block｀ 将会 同步执行的。</div><div class="line">	*/</div><div class="line">	<span class="comment">//do something</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 改成：</span></div><div class="line"></div><div class="line"><span class="comment">//! 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">BusinessBlockOperation *bOP = [BusinessBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 特别注意：请确保 读写CoreData数据库的 ｀block｀ 将会 同步执行的。</div><div class="line">	*/</div><div class="line">	<span class="comment">//do something</span></div><div class="line">&#125;];<span class="comment">//&lt;—— 在自定义操作队列：读写 本地数据库CoreData ——&gt;//</span></div><div class="line"><span class="comment">// 在自定义操作队列：读写 本地数据库CoreData</span></div><div class="line">[[[BusinessManager sharedManager] systemAccountManager].operationQueue addOperation:bOP];</div></pre></td></tr></table></figure>
<h5 id="CoreData-谓词NSPredicate"><a href="#CoreData-谓词NSPredicate" class="headerlink" title="CoreData 谓词NSPredicate"></a>CoreData 谓词NSPredicate</h5><p><a href="http://nshipster.cn/nspredicate/" target="_blank" rel="external">nshipster.cn NSPredicate</a> NSPredicate是一个Foundation类，它指定数据被获取或者过滤的方式。它的查询语言就像SQL的WHERE和正则表达式的交叉一样，提供了具有表现力的，自然语言界面来定义一个集合被搜寻的逻辑条件。</p>
<p><a href="http://stackoverflow.com/questions/2740933/nspredicate-that-is-the-equivalent-of-sqls-like" target="_blank" rel="external">NSPredicate that is the equivalent of SQL’s LIKE</a></p>
<p><a href="http://userguide.icu-project.org/strings/regexp" target="_blank" rel="external">Regular Expressions</a></p>
<p><a href="http://nshipster.cn/nsexpression/" target="_blank" rel="external">nshipster.cn NSExpression</a></p>
<p><a href="http://nshipster.cn/kvc-collection-operators/" target="_blank" rel="external">KVC Collection Operators</a></p>
<p><a href="http://stackoverflow.com/questions/1164338/core-data-nspredicate-and-to-many-key?rq=1" target="_blank" rel="external">Core Data, NSPredicate and to-many key (CoreData数据关系 的 谓词1)</a><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">NSPredicate</span> * dayIsNotExcludedPredicate = [NSPredicate predicateWithFormat: </div><div class="line">	@<span class="string">"excludedDays.<span class="variable">@count</span> == 0 || (excludedDays.<span class="variable">@count</span> &gt; 0 &amp;&amp; NONE excludedDays.day == %@))"</span>, </div><div class="line">	today];</div></pre></td></tr></table></figure></p>
<p><a href="http://stackoverflow.com/questions/1347776/how-to-correctly-setup-a-nspredicate-for-a-to-many-relationship-when-using-core?rq=1" target="_blank" rel="external">How to correctly setup a NSPredicate for a to-many relationship when using Core Data? (CoreData数据关系 的 谓词2)</a><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[NSPredicate predicateWithFormat:</div><div class="line">	<span class="meta">@"(excludedOccurrences.</span><span class="meta">@count</span> == 0) OR (0 == SUBQUERY(excludedOccurrences, $sub, $sub.day == %<span class="meta">@).</span><span class="meta">@count)",</span> </div><div class="line">	today]</div></pre></td></tr></table></figure></p>
<p><a href="http://stackoverflow.com/questions/2006927/whats-better-way-to-build-nspredicate-with-to-many-deep-relationships" target="_blank" rel="external">What’s better way to build NSPredicate with to-many deep relationships?  (CoreData数据关系 的 谓词3)</a></p>
<h5 id="CoreData的关系型数据"><a href="#CoreData的关系型数据" class="headerlink" title="CoreData的关系型数据"></a>CoreData的关系型数据</h5><p><img src="http://7xpc28.com1.z0.glb.clouddn.com/MyAppExample_CoreData_Schema.png" alt=""></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*! @brief 联系人－数据模型</span></div><div class="line"> *  @author OuYangXiaoJin 2016.03.21</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HTmContactEntity</span> : <span class="title">BaseManagedObject</span></span></div><div class="line"></div><div class="line"><span class="comment">// 这张table的其他field</span></div><div class="line"></div><div class="line"><span class="comment">// 下面是这张table与其他table的数据关系</span></div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 所属 群组 （to-many）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span>&lt;HTmGroupEntity*&gt;  *belongGroups;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 包含 callee通话记录（to-many）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span>&lt;HTmCallRecordEntity*&gt;  *hasCalleeRecords;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 包含 caller通话记录（to-many）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span>&lt;HTmCallRecordEntity*&gt;  *hasCallerRecords;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 拥有 已经绑定的设备（to-many）</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span>&lt;HTmBindDeviceEntity *&gt;  *hasBindDevices;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*! @brief  CoreData关系型数据：联系人HTmContactEntity 和 其它Entity 的关系。</span></div><div class="line"> *  @author OuYangXiaoJin 2016.04.13</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HTmContactEntity</span> (<span class="title">CoreDataGeneratedAccessors</span>)</span></div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 所属 群组</span></div><div class="line">- (<span class="keyword">void</span>)addBelongGroupsObject:(HTmGroupEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)removeBelongGroupsObject:(HTmGroupEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)addBelongGroups:(<span class="built_in">NSSet</span> *)values;</div><div class="line">- (<span class="keyword">void</span>)removeBelongGroups:(<span class="built_in">NSSet</span> *)values;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 包含 callee通话记录</span></div><div class="line">- (<span class="keyword">void</span>)addHasCalleeRecordsObject:(HTmCallRecordEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)removeHasCalleeRecordsObject:(HTmCallRecordEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)addHasCalleeRecords:(<span class="built_in">NSSet</span> *)values;</div><div class="line">- (<span class="keyword">void</span>)removeHasCalleeRecords:(<span class="built_in">NSSet</span> *)values;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 包含 caller通话记录</span></div><div class="line">- (<span class="keyword">void</span>)addHasCallerRecordsObject:(HTmCallRecordEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)removeHasCallerRecordsObject:(HTmCallRecordEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)addHasCallerRecords:(<span class="built_in">NSSet</span> *)values;</div><div class="line">- (<span class="keyword">void</span>)removeHasCallerRecords:(<span class="built_in">NSSet</span> *)values;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：当前联系人 拥有 已经绑定的设备</span></div><div class="line">- (<span class="keyword">void</span>)addHasBindDevicesObject:(HTmBindDeviceEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)removeHasBindDevicesObject:(HTmBindDeviceEntity *)value;</div><div class="line">- (<span class="keyword">void</span>)addHasBindDevices:(<span class="built_in">NSSet</span> *)values;</div><div class="line">- (<span class="keyword">void</span>)removeHasBindDevices:(<span class="built_in">NSSet</span> *)values;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">移除 数据关系 (many-many)</div><div class="line"> */</div><div class="line">[obj                  removeBelongAccountsObject: currentAccountEntity];</div><div class="line">[currentAccountEntity removeHasBindDevicesObject: obj];</div><div class="line">                                                </div><div class="line"><span class="comment">/**</span></div><div class="line">建立 数据关系 (many-many)</div><div class="line">*/</div><div class="line">[currentAccountEntity addHasBindDevicesObject: aBdEntity];</div><div class="line">[aBdEntity            addBelongAccountsObject: currentAccountEntity];</div></pre></td></tr></table></figure>
<h5 id="CoreData的Entity深拷贝"><a href="#CoreData的Entity深拷贝" class="headerlink" title="CoreData的Entity深拷贝"></a>CoreData的Entity深拷贝</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*! @brief  深拷贝</span></div><div class="line"> *</div><div class="line"> *  @param  source 拷贝源。</div><div class="line"> *  @param  context 上下文，可以为nil。</div><div class="line"> *</div><div class="line"> *  @return 实体，使用时请强制转换成 相应的实体。</div><div class="line"> */</div><div class="line">+ (<span class="built_in">NSManagedObject</span> *)clone:(<span class="built_in">NSManagedObject</span> *)source</div><div class="line">                 inContext:(<span class="built_in">NSManagedObjectContext</span> *)context</div><div class="line">&#123;</div><div class="line">    <span class="comment">//  预处理</span></div><div class="line">    <span class="keyword">if</span> (<span class="literal">nil</span> == context) &#123;<span class="comment">//参数context上下文为nil，则与拷贝源source使用同一个上下文。</span></div><div class="line">        context = [source managedObjectContext];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="literal">nil</span> == [source managedObjectContext]) &#123;<span class="comment">//拷贝源source的上下文不存在，说明此拷贝源source 已经是拷贝的了。</span></div><div class="line">        <span class="keyword">return</span> source;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     How can I duplicate, or copy a Core Data Managed Object?</div><div class="line">     Ref.:  http://stackoverflow.com/questions/2730832/how-can-i-duplicate-or-copy-a-core-data-managed-object</div><div class="line">     */</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     //注释这里。不能把 克隆的数据cloned 插入 source的上下文context，因为会导致上下文context中 数据重复。</div><div class="line">     //create new object in data store</div><div class="line">     NSManagedObject *cloned = [NSEntityDescription</div><div class="line">                                insertNewObjectForEntityForName:entityName</div><div class="line">                                inManagedObjectContext:context];</div><div class="line">     */</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     How to Deal with Temporary NSManagedObject instances?</div><div class="line">     Ref.:  http://stackoverflow.com/questions/3256195/how-to-deal-with-temporary-nsmanagedobject-instances</div><div class="line">     */</div><div class="line">    <span class="built_in">NSEntityDescription</span> *entity = [source entity];</div><div class="line">    <span class="built_in">NSManagedObject</span> *cloned = [[<span class="built_in">NSManagedObject</span> alloc] initWithEntity:entity</div><div class="line">                                       insertIntoManagedObjectContext:<span class="literal">nil</span>];</div><div class="line"></div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *entityName = [[source entity] name];</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//loop through all attributes and assign then to the clone</span></div><div class="line">    <span class="built_in">NSDictionary</span> *attributes = [[<span class="built_in">NSEntityDescription</span></div><div class="line">                                 entityForName:entityName</div><div class="line">                                 inManagedObjectContext:context] attributesByName];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *attr <span class="keyword">in</span> attributes) &#123;</div><div class="line">        [cloned setValue:[source valueForKey:attr] forKey:attr];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//Loop through all relationships, and clone them.</span></div><div class="line">    <span class="built_in">NSDictionary</span> *relationships = [[<span class="built_in">NSEntityDescription</span></div><div class="line">                                    entityForName:entityName</div><div class="line">                                    inManagedObjectContext:context] relationshipsByName];</div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSRelationshipDescription</span> *rel <span class="keyword">in</span> relationships)&#123;</div><div class="line">        <span class="built_in">NSString</span> *keyName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,rel];</div><div class="line">        <span class="comment">//get a set of all objects in the relationship</span></div><div class="line">        <span class="built_in">NSMutableSet</span> *sourceSet = [source mutableSetValueForKey:keyName];</div><div class="line">        <span class="built_in">NSMutableSet</span> *clonedSet = [cloned mutableSetValueForKey:keyName];</div><div class="line">        <span class="built_in">NSEnumerator</span> *e = [sourceSet objectEnumerator];</div><div class="line">        <span class="built_in">NSManagedObject</span> *relatedObject;</div><div class="line">        <span class="keyword">while</span> ( relatedObject = [e nextObject])&#123;</div><div class="line">            <span class="comment">//Clone it, and add clone to set</span></div><div class="line">            <span class="built_in">NSManagedObject</span> *clonedRelatedObject = [<span class="keyword">self</span> clone:relatedObject</div><div class="line">                                                     inContext:context];</div><div class="line">            [clonedSet addObject:clonedRelatedObject];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> cloned;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CoreData实体Entity深度拷贝(每一个‘字段’、每一个‘数据关系’)，Context上下文 数据重复，导致PersistentStoreFile数据库重复 —&gt; fix BUG —&gt; 自测 通过。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - 实体更新 - private</span></div><div class="line"></div><div class="line"><span class="comment">/*! @brief  实体更新：把 sourceEntity实体的所有字段 覆盖 destinationEntity实体的所有字段 (除了attributeNames这些字段)。</span></div><div class="line"> *</div><div class="line"> *  @param  sourceEntity 源头 数据实体。</div><div class="line"> *  @param  context 源头 数据实体，所在的 上下文。</div><div class="line"> *  @param  destinationEntity 目标 数据实体。</div><div class="line"> *  @param  attributeNames 跳过 这些字段。</div><div class="line"> *</div><div class="line"> *  @return 把 sourceEntity实体的所有字段 覆盖 destinationEntity实体的所有字段 (除了attributeNames这些字段)；</div><div class="line"> 若 成功，则YES；否则 NO。</div><div class="line"> */</div><div class="line">+ (<span class="built_in">BOOL</span>)p_cloneSourceEntity:(<span class="built_in">NSManagedObject</span> *_Nonnull)sourceEntity</div><div class="line">                  inContext:(<span class="built_in">NSManagedObjectContext</span> *_Nullable)sourceEntityInContext</div><div class="line">      intoDestinationEntity:(<span class="built_in">NSManagedObject</span> *_Nonnull __<span class="keyword">strong</span> *_Nonnull)destinationEntity</div><div class="line">            insertInContext:(<span class="built_in">NSManagedObjectContext</span> *_Nonnull __<span class="keyword">strong</span> *_Nonnull)destinationEntityInsertContext</div><div class="line">           ignoreAttributes:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span>*&gt; *_Nullable)ignoreAttributeNames</div><div class="line">    relationshipDescription:(<span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSRelationshipDescription</span>*&gt; *_Nonnull __<span class="keyword">strong</span> *_Nonnull)hasLoopThroughRelationshipDescription;</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> isSuccess = <span class="literal">NO</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     注意：&amp;errorOnMain，是double pointer。</div><div class="line">     How do pointer to pointers work in C? ------ double pointer</div><div class="line">     http://stackoverflow.com/questions/897366/how-do-pointer-to-pointers-work-in-c</div><div class="line">     by OYXJ 2015-09－02</div><div class="line">     */</div><div class="line">    <span class="built_in">NSManagedObject</span> *source = sourceEntity;       <span class="comment">// 注意，这里一定是 strong reference。</span></div><div class="line">    <span class="built_in">NSManagedObject</span> *cloned = *destinationEntity; <span class="comment">// 注意，这里一定是 strong reference。</span></div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//  预处理</span></div><div class="line">    <span class="keyword">if</span> (<span class="literal">nil</span> == sourceEntityInContext) &#123;<span class="comment">//参数context上下文为nil，则与拷贝源source使用同一个上下文。</span></div><div class="line">        sourceEntityInContext = [source managedObjectContext];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="literal">nil</span> == [source managedObjectContext]) &#123;</div><div class="line">        <span class="comment">// 注意，context一定不能为nil。</span></div><div class="line">        DDLogError(<span class="string">@"%@ %@, %@"</span>, THIS_FILE,THIS_METHOD, <span class="string">@"注意，context一定不能为nil。"</span>);</div><div class="line">        isSuccess = <span class="literal">NO</span>;</div><div class="line">        <span class="keyword">return</span> isSuccess; <span class="comment">// 返回NO</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">/*</span></div><div class="line">     How can I duplicate, or copy a Core Data Managed Object?</div><div class="line">     Ref.:  http://stackoverflow.com/questions/2730832/how-can-i-duplicate-or-copy-a-core-data-managed-object</div><div class="line">     */</div><div class="line">    </div><div class="line">    &#123;<span class="comment">//[begin] --- 实体拷贝</span></div><div class="line">        <span class="comment">/**</span></div><div class="line">         拷贝对象cloned  每个'字段'、每个'数据关系' 重新赋值</div><div class="line">         */</div><div class="line">        <span class="built_in">NSString</span> *entityName = [[source entity] name];<span class="comment">//表名</span></div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="comment">//loop through all attributes and assign then to the clone</span></div><div class="line">        <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="built_in">NSAttributeDescription</span> *&gt; *attributes =</div><div class="line">            [[<span class="built_in">NSEntityDescription</span> entityForName: entityName</div><div class="line">                         inManagedObjectContext: sourceEntityInContext] <span class="comment">//Raises NSInternalInconsistencyException if context is nil.</span></div><div class="line">             attributesByName];</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *attr <span class="keyword">in</span> attributes) &#123;<span class="comment">//遍历 每个字段</span></div><div class="line">            <span class="built_in">BOOL</span> isIgnoreAttr = <span class="literal">NO</span>;<span class="comment">//是否 忽略该字段</span></div><div class="line">            <span class="keyword">for</span> (<span class="built_in">NSString</span> *each_ignoreAttr <span class="keyword">in</span> ignoreAttributeNames) &#123;</div><div class="line">                <span class="keyword">if</span> ([attr isEqualToString:each_ignoreAttr]) &#123;</div><div class="line">                    isIgnoreAttr = <span class="literal">YES</span>;<span class="comment">//是否 忽略该字段 --- YES</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isIgnoreAttr==<span class="literal">NO</span>) &#123;<span class="comment">//是否 忽略该字段 --- NO</span></div><div class="line">                [cloned setValue:[source valueForKey:attr] forKey:attr];<span class="comment">//loop through all attributes and assign then to the clone</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//Loop through all relationships, and clone them.</span></div><div class="line">        <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="built_in">NSRelationshipDescription</span> *&gt; *relationships =</div><div class="line">            [[<span class="built_in">NSEntityDescription</span> entityForName: entityName</div><div class="line">                         inManagedObjectContext: sourceEntityInContext] <span class="comment">//Raises NSInternalInconsistencyException if context is nil.</span></div><div class="line">                relationshipsByName];</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">NSRelationshipDescription</span> *rel <span class="keyword">in</span> relationships)&#123;<span class="comment">//遍历 每个‘数据关系’</span></div><div class="line">            <span class="keyword">if</span> ([*hasLoopThroughRelationshipDescription containsObject:rel])&#123;<span class="comment">//退出"递归"的条件</span></div><div class="line">                <span class="keyword">continue</span>;<span class="comment">// 这个是，退出“递归”。</span></div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//根据 CoreData每一张表的数据关系链，遍历。记录此数据关系；以便之后 退出“递归”。</span></div><div class="line">                [*hasLoopThroughRelationshipDescription addObject:rel];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="built_in">NSString</span> *keyName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,rel];</div><div class="line">            </div><div class="line">            <span class="built_in">BOOL</span> isIgnoreRel = <span class="literal">NO</span>;<span class="comment">//是否 忽略该'数据关系'</span></div><div class="line">            <span class="keyword">for</span> (<span class="built_in">NSString</span> *each_ignoreAttr <span class="keyword">in</span> ignoreAttributeNames) &#123;</div><div class="line">                <span class="keyword">if</span> ([keyName isEqualToString:each_ignoreAttr]) &#123;</div><div class="line">                    isIgnoreRel = <span class="literal">YES</span>;<span class="comment">//是否 忽略该'数据关系' --- YES</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isIgnoreRel==<span class="literal">YES</span>) &#123;<span class="comment">//是否 忽略该'数据关系' --- YES</span></div><div class="line">                <span class="keyword">continue</span>;<span class="comment">//忽略该'数据关系'</span></div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            </div><div class="line">            <span class="comment">//to-one relationship ？</span></div><div class="line">            <span class="comment">//- (nullable id)valueForKey:(NSString *)key;</span></div><div class="line">            </div><div class="line">            <span class="comment">//to-many relationship ？</span></div><div class="line">            <span class="comment">//- (NSMutableSet *)mutableSetValueForKey:(NSString *)key;</span></div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             NSKeyValueCoding.h   valueForKey</div><div class="line">             </div><div class="line">             Ref.:  Apple Document</div><div class="line">             </div><div class="line">            Given a key that identifies an attribute or to-one relationship, return the attribute value or the related object. Given a key that identifies a to-many relationship, return an immutable array or an immutable set that contains all of the related objects.</div><div class="line">            */</div><div class="line">            <span class="keyword">id</span> sourceId = [source valueForKey:keyName];<span class="comment">//to-one relationship OR to-many relationship</span></div><div class="line">            <span class="comment">// id clonedID = [cloned valueForKey:keyName];//to-one relationship OR to-many relationship</span></div><div class="line">            <span class="keyword">if</span> (sourceId) &#123;</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> ([sourceId isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]] || [sourceId isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;<span class="comment">//to-many relationship</span></div><div class="line">                    </div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     NSKeyValueCoding.h   mutableSetValueForKey</div><div class="line">                     </div><div class="line">                     Ref.:  Apple Document</div><div class="line">                     </div><div class="line">                     Given a key that identifies an _unordered_ and uniquing to-many relationship, return a mutable set that provides read-write access to the related objects. Objects added to the mutable set will become related to the receiver, and objects removed from the mutable set will become unrelated.</div><div class="line">                     */</div><div class="line">                    <span class="comment">//get a set of all objects in the relationship</span></div><div class="line">                    <span class="built_in">NSMutableSet</span> *sourceSet = [source mutableSetValueForKey:keyName];<span class="comment">//to-many relationship</span></div><div class="line">                    <span class="built_in">NSMutableSet</span> *clonedSet = [cloned mutableSetValueForKey:keyName];<span class="comment">//to-many relationship</span></div><div class="line">                    <span class="built_in">NSEnumerator</span> *e = [[sourceSet mutableCopy] objectEnumerator];<span class="comment">// <span class="doctag">TODO:</span> mutableCopy <span class="doctag">TODO:</span> ??</span></div><div class="line">                    <span class="built_in">NSManagedObject</span> *relatedObject;</div><div class="line">                    <span class="keyword">while</span> ( relatedObject = [e nextObject])&#123;</div><div class="line">                        <span class="comment">//Clone it, and add clone to set</span></div><div class="line">                        </div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         注释 此处的代码 --- [begin]</div><div class="line">                         </div><div class="line">                         NSManagedObject *clonedRelatedObject = [self clone: relatedObject</div><div class="line">                                                                  inContext: context];</div><div class="line">                         [clonedSet addObject: clonedRelatedObject];</div><div class="line">                         </div><div class="line">                         注释 此处的代码 --- [end]</div><div class="line">                         */</div><div class="line">                        </div><div class="line">                        </div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         How to Deal with Temporary NSManagedObject instances?</div><div class="line">                         Ref.:  http://stackoverflow.com/questions/3256195/how-to-deal-with-temporary-nsmanagedobject-instances</div><div class="line">                         */</div><div class="line"><span class="comment">//                        NSEntityDescription *local_entityDesc = [relatedObject entity];</span></div><div class="line"><span class="comment">//                        NSManagedObject *local_clonedRelatedObject =</span></div><div class="line"><span class="comment">//                            [[NSManagedObject alloc] initWithEntity: local_entityDesc</span></div><div class="line"><span class="comment">//                                     insertIntoManagedObjectContext: *destinationEntityInsertContext];//这里会导致数据库的数据重复，所以注释。</span></div><div class="line">                        </div><div class="line">                        <span class="built_in">NSManagedObject</span> *local_clonedRelatedObject = [<span class="keyword">self</span> p_existingObjectWithID: relatedObject.objectID</div><div class="line">                                                                                        inContext: *destinationEntityInsertContext];</div><div class="line">                        <span class="keyword">if</span> (local_clonedRelatedObject) &#123;</div><div class="line"></div><div class="line">                            <span class="comment">// // NSManagedObjectContext *local_context = [relatedObject managedObjectContext];</span></div><div class="line">                            </div><div class="line">                            <span class="built_in">BOOL</span> isSuc = [<span class="keyword">self</span> p_cloneSourceEntity: relatedObject</div><div class="line">                                                         inContext: sourceEntityInContext</div><div class="line">                                             intoDestinationEntity: &amp;local_clonedRelatedObject              <span class="comment">//double pointer</span></div><div class="line">                                                   insertInContext: destinationEntityInsertContext          <span class="comment">//double pointer</span></div><div class="line">                                                  ignoreAttributes: ignoreAttributeNames</div><div class="line">                                           relationshipDescription: hasLoopThroughRelationshipDescription]; <span class="comment">//double pointer</span></div><div class="line">                            </div><div class="line">                            <span class="keyword">if</span> (isSuc) &#123;</div><div class="line">                                <span class="comment">//Objects added to the mutable set will become related to the receiver, and objects removed from the mutable set will become unrelated.</span></div><div class="line">                                [clonedSet addObject:local_clonedRelatedObject];<span class="comment">//Loop through all relationships, and clone them.</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;<span class="comment">//&lt;--- while遍历 ---&gt;//</span></div><div class="line">                    </div><div class="line">                &#125;<span class="keyword">else</span>&#123;<span class="comment">//to-one relationship</span></div><div class="line">                    </div><div class="line">                    <span class="built_in">NSManagedObject</span> *relatedObject = sourceId;</div><div class="line">                    </div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     How to Deal with Temporary NSManagedObject instances?</div><div class="line">                     Ref.:  http://stackoverflow.com/questions/3256195/how-to-deal-with-temporary-nsmanagedobject-instances</div><div class="line">                     */</div><div class="line"><span class="comment">//                    NSEntityDescription *local_entityDesc = [relatedObject entity];</span></div><div class="line"><span class="comment">//                    NSManagedObject *local_clonedRelatedObject =</span></div><div class="line"><span class="comment">//                        [[NSManagedObject alloc] initWithEntity: local_entityDesc</span></div><div class="line"><span class="comment">//                                 insertIntoManagedObjectContext: *destinationEntityInsertContext];//这里会导致数据库的数据重复，所以注释。</span></div><div class="line">                    </div><div class="line">                    <span class="built_in">NSManagedObject</span> *local_clonedRelatedObject = [<span class="keyword">self</span> p_existingObjectWithID: relatedObject.objectID</div><div class="line">                                                                                    inContext: *destinationEntityInsertContext];</div><div class="line">                    <span class="keyword">if</span> (local_clonedRelatedObject) &#123;</div><div class="line">                        </div><div class="line">                        <span class="comment">// // NSManagedObjectContext *local_context = [relatedObject managedObjectContext];</span></div><div class="line"></div><div class="line">                        <span class="built_in">BOOL</span> isSuc = [<span class="keyword">self</span> p_cloneSourceEntity: relatedObject</div><div class="line">                                                     inContext: sourceEntityInContext</div><div class="line">                                         intoDestinationEntity: &amp;local_clonedRelatedObject                  <span class="comment">//double pointer</span></div><div class="line">                                               insertInContext: destinationEntityInsertContext              <span class="comment">//double pointer</span></div><div class="line">                                              ignoreAttributes: ignoreAttributeNames</div><div class="line">                                       relationshipDescription: hasLoopThroughRelationshipDescription];     <span class="comment">//double pointer</span></div><div class="line"></div><div class="line">                        <span class="keyword">if</span> (isSuc) &#123;</div><div class="line">                            <span class="comment">//Objects added to the mutable set will become related to the receiver, and objects removed from the mutable set will become unrelated.</span></div><div class="line">                            <span class="comment">// // id clonedID = [cloned valueForKey:keyName];//to-one relationship OR to-many relationship</span></div><div class="line">                            <span class="comment">// // clonedID = local_clonedRelatedObject;</span></div><div class="line">                            [cloned setValue:local_clonedRelatedObject forKey:keyName];<span class="comment">//Loop through all relationships, and clone them.</span></div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;<span class="comment">//&lt;--- for遍历 ---&gt;//</span></div><div class="line">        </div><div class="line">        </div><div class="line">        isSuccess = <span class="literal">YES</span>; <span class="comment">// 这个很重要 ！</span></div><div class="line">    &#125;<span class="comment">//[end] --- 实体拷贝</span></div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">return</span> isSuccess;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> 依赖方法： - (NSManagedObject *)existingObjectWithID:(NSManagedObjectID *)objectID error:(NSError **)error</div><div class="line"> </div><div class="line"> Return Value：</div><div class="line"> The object specified by objectID. If the object cannot be fetched, or does not exist, or cannot be faulted, it returns nil.</div><div class="line"> </div><div class="line"> Discussion：</div><div class="line"> If there is a managed object with the given ID already registered in the context, that object is returned directly; otherwise the corresponding object is faulted into the context.</div><div class="line"> </div><div class="line"> This method might perform I/O if the data is uncached.</div><div class="line"> </div><div class="line"> Unlike objectWithID:, this method never returns a fault.</div><div class="line"> */</div><div class="line">+ (<span class="built_in">NSManagedObject</span> *)p_existingObjectWithID:(<span class="built_in">NSManagedObjectID</span> *)aObjectID</div><div class="line">                                  inContext:(<span class="built_in">NSManagedObjectContext</span> *)aContext</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(!aObjectID)</div><div class="line">    &#123;</div><div class="line">        DDLogError(<span class="string">@"%@ %@ ,%@"</span>, THIS_FILE,THIS_METHOD, <span class="string">@"参数 aObjectID is nil"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSManagedObject</span> *object = <span class="literal">nil</span>;</div><div class="line">    <span class="built_in">NSError</span> * opError = <span class="literal">nil</span>;</div><div class="line">    &#123;</div><div class="line">        object = [aContext existingObjectWithID:aObjectID error:&amp;opError];</div><div class="line">        <span class="keyword">if</span>(opError)</div><div class="line">        &#123;</div><div class="line">            DDLogError(<span class="string">@"%@ %@ , error:%@"</span>, THIS_FILE,THIS_METHOD, opError);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(!object)</div><div class="line">        &#123;</div><div class="line">            DDLogError(<span class="string">@"%@ %@ , %@ %@"</span>, THIS_FILE,THIS_METHOD, aObjectID, <span class="string">@"查询：object is nil"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    DDLogError(<span class="string">@"%@ %@ , %@ %@"</span>, THIS_FILE,THIS_METHOD, aObjectID, <span class="string">@"查询：object is found"</span>);</div><div class="line">    <span class="keyword">return</span> object;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>entity深拷贝，举例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">应用于  HTmLocalAddressBookInviteController.m （本地通讯录-邀请页面）</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  关联 临时实体 的 临时上下文</div><div class="line"> *  @attention 临时上下文 可以insert 临时实体；</div><div class="line"> *  @attention 临时上下文 一定不能save，切记切记！</div><div class="line"> *</div><div class="line"> *  @return 临时上下文</div><div class="line"> */</div><div class="line">- (<span class="built_in">NSManagedObjectContext</span> *)tempMainQueueContext</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!_tempMainQueueContext) &#123;</div><div class="line"><span class="comment">//        _tempMainQueueContext = (&#123;</span></div><div class="line">        </div><div class="line">        </div><div class="line">            <span class="comment">//! 当前线程 的托管对象上下文</span></div><div class="line">            <span class="built_in">NSManagedObjectContext</span> *curThreadContext = [[DataBaseManager sharedDataBaseManager]</div><div class="line">                                                        currentThreadManagedObjectContext];</div><div class="line">            </div><div class="line">            </div><div class="line">            <span class="comment">/**</span></div><div class="line">             临时的 主队列Context：关联 临时实体 的 临时上下文</div><div class="line">             @attention 临时上下文 可以insert 临时实体；</div><div class="line">             @attention 临时上下文 一定不能save，切记切记！</div><div class="line">             */</div><div class="line">        _tempMainQueueContext</div><div class="line">            <span class="comment">/*NSManagedObjectContext *mainQueueContext*/</span> = [[<span class="built_in">NSManagedObjectContext</span> alloc] initWithConcurrencyType:</div><div class="line">                                                        <span class="built_in">NSMainQueueConcurrencyType</span>];</div><div class="line">            [_tempMainQueueContext setPersistentStoreCoordinator: curThreadContext.persistentStoreCoordinator];<span class="comment">//共用一个Coordinator</span></div><div class="line">            [_tempMainQueueContext setMergePolicy:                curThreadContext.mergePolicy];</div><div class="line">            [_tempMainQueueContext setUndoManager: <span class="literal">nil</span>];</div><div class="line">            </div><div class="line">        </div><div class="line">        </div><div class="line">            &#123;<span class="comment">//</span></div><div class="line">                <span class="built_in">NSMutableArray</span>&lt;HTmContactEntity *&gt;  *myArr = [[<span class="built_in">NSMutableArray</span> alloc] initWithCapacity:<span class="number">2</span>];</div><div class="line">                </div><div class="line">                <span class="comment">//! iPhoneAddressBook通讯录 不支持HomeTime 的联系人 (这是 临时上下文 的 临时实体)</span></div><div class="line">                <span class="built_in">NSArray</span>&lt;HTmContactEntity *&gt;  *tmpCEArr = [[[BusinessManager sharedManager] localContactManager]</div><div class="line">                                                          getNonHomeTimeContactEntitys];</div><div class="line">                [tmpCEArr enumerateObjectsUsingBlock:^(HTmContactEntity * _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</div><div class="line">                    HTmContactEntity *sourceEntity = obj;</div><div class="line">                    <span class="built_in">NSManagedObjectContext</span> *destinationEntityInsertContext = _tempMainQueueContext;</div><div class="line">                    </div><div class="line">                    <span class="comment">// 克隆 实体</span></div><div class="line">                    <span class="built_in">NSEntityDescription</span> *entityDesc = [sourceEntity entity];</div><div class="line">                    HTmContactEntity *cloned = (HTmContactEntity*)[[<span class="built_in">NSManagedObject</span> alloc] initWithEntity: entityDesc</div><div class="line">                                                                    insertIntoManagedObjectContext: destinationEntityInsertContext];</div><div class="line">                    </div><div class="line">                    <span class="built_in">BOOL</span> isSuc = [HTmContactEntity cloneSourceEntity: sourceEntity</div><div class="line">                                                           inContext: sourceEntity.managedObjectContext</div><div class="line">                                               intoDestinationEntity: &amp;cloned                            <span class="comment">//double pointer</span></div><div class="line">                                                     insertInContext: &amp;destinationEntityInsertContext];  <span class="comment">//double pointer</span></div><div class="line">                    <span class="keyword">if</span> (isSuc) &#123;</div><div class="line">                        [myArr addObject:cloned];</div><div class="line">                    &#125;</div><div class="line">                &#125;];</div><div class="line">                </div><div class="line">                </div><div class="line">                _tempNonHomeTimeContacts = [myArr <span class="keyword">copy</span>];</div><div class="line">            &#125;<span class="comment">//</span></div><div class="line">            </div><div class="line">            </div><div class="line">            <span class="comment">//! 把 临时数据 插入到 临时的主队列Context；一定不能 保存！</span></div><div class="line"><span class="comment">//            NSArray&lt;HTmContactEntity *&gt;  *tmpNonHomeTimeContacts = [self tempNonHomeTimeContacts];</span></div><div class="line"><span class="comment">//            NSArray&lt;HTmContactEntity *&gt;  *tmpNonHomeTimeContacts = _tempNonHomeTimeContacts;</span></div><div class="line">        </div><div class="line"><span class="comment">//            //步骤一：</span></div><div class="line"><span class="comment">//            [tmpNonHomeTimeContacts enumerateObjectsUsingBlock:^(HTmContactEntity * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span></div><div class="line"><span class="comment">//                // 删除 临时实体</span></div><div class="line"><span class="comment">//                [_tempMainQueueContext deleteObject:obj];</span></div><div class="line"><span class="comment">//            &#125;];</span></div><div class="line"><span class="comment">//            //步骤二：</span></div><div class="line"><span class="comment">//            [tmpNonHomeTimeContacts enumerateObjectsUsingBlock:^(HTmContactEntity * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span></div><div class="line"><span class="comment">//                /**</span></div><div class="line"><span class="comment">//                 插入 临时实体</span></div><div class="line"><span class="comment">//                 临时上下文 一定不能save，切记切记！</span></div><div class="line"><span class="comment">//                 */</span></div><div class="line"><span class="comment">//                [_tempMainQueueContext insertObject:obj];</span></div><div class="line"><span class="comment">//            &#125;];</span></div><div class="line"> </div><div class="line">            </div><div class="line"><span class="comment">//            mainQueueContext; //返回：主队列Context</span></div><div class="line"><span class="comment">//        &#125;);</span></div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _tempMainQueueContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">(lldb) po relationships</div><div class="line">&#123;</div><div class="line">    belongGroups = "(&lt;NSRelationshipDescription: 0x1270031f0&gt;), name belongGroups, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier belongGroups, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmGroupEntity, inverseRelationship hasContacts, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">    hasBindDevices = "(&lt;NSRelationshipDescription: 0x1270032a0&gt;), name hasBindDevices, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hasBindDevices, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmBindDeviceEntity, inverseRelationship belongContacts, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">    hasCalleeRecords = "(&lt;NSRelationshipDescription: 0x127003350&gt;), name hasCalleeRecords, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hasCalleeRecords, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmCallRecordEntity, inverseRelationship belongCalleeContact, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">    hasCallerRecords = "(&lt;NSRelationshipDescription: 0x125eefc80&gt;), name hasCallerRecords, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hasCallerRecords, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmCallRecordEntity, inverseRelationship belongCallerContact, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">&#125;</div><div class="line"></div><div class="line">(lldb) </div><div class="line"></div><div class="line">Printing description of attributes:</div><div class="line">&#123;</div><div class="line">    abRecordID = "(&lt;NSAttributeDescription: 0x141047d20&gt;), name abRecordID, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier abRecordID, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    blackListPhoneNumbers = "(&lt;NSAttributeDescription: 0x141047db0&gt;), name blackListPhoneNumbers, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier blackListPhoneNumbers, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    colorHexValue = "(&lt;NSAttributeDescription: 0x141047e40&gt;), name colorHexValue, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier colorHexValue, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 200 , attributeValueClassName NSNumber, defaultValue 0";</div><div class="line">    contactTypeBitmask = "(&lt;NSAttributeDescription: 0x141047ed0&gt;), name contactTypeBitmask, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier contactTypeBitmask, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 100 , attributeValueClassName NSNumber, defaultValue 0";</div><div class="line">    dataSourceType = "(&lt;NSAttributeDescription: 0x141047f60&gt;), name dataSourceType, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier dataSourceType, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 100 , attributeValueClassName NSNumber, defaultValue 0";</div><div class="line">    "data_1" = "(&lt;NSAttributeDescription: 0x141047ff0&gt;), name data_1, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier data_1, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    "data_2" = "(&lt;NSAttributeDescription: 0x141048080&gt;), name data_2, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier data_2, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    "data_3" = "(&lt;NSAttributeDescription: 0x141048110&gt;), name data_3, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier data_3, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    "data_4" = "(&lt;NSAttributeDescription: 0x1410481a0&gt;), name data_4, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier data_4, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    "data_5" = "(&lt;NSAttributeDescription: 0x141048230&gt;), name data_5, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier data_5, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    deviceID = "(&lt;NSAttributeDescription: 0x1410482c0&gt;), name deviceID, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier deviceID, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    entityUUID = "(&lt;NSAttributeDescription: 0x141048350&gt;), name entityUUID, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier entityUUID, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    etag = "(&lt;NSAttributeDescription: 0x1410483e0&gt;), name etag, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier etag, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    firstLetterSpell = "(&lt;NSAttributeDescription: 0x141048470&gt;), name firstLetterSpell, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier firstLetterSpell, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    foreignKeyAccountUserID = "(&lt;NSAttributeDescription: 0x141048500&gt;), name foreignKeyAccountUserID, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier foreignKeyAccountUserID, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    fullSpell = "(&lt;NSAttributeDescription: 0x141048590&gt;), name fullSpell, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier fullSpell, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    headIconPath = "(&lt;NSAttributeDescription: 0x141048620&gt;), name headIconPath, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier headIconPath, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    hometimePhoneNumbers = "(&lt;NSAttributeDescription: 0x1410486b0&gt;), name hometimePhoneNumbers, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hometimePhoneNumbers, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    indexMark = "(&lt;NSAttributeDescription: 0x141048740&gt;), name indexMark, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier indexMark, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    isAddedContactBySyncingServer = "(&lt;NSAttributeDescription: 0x1410487d0&gt;), name isAddedContactBySyncingServer, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isAddedContactBySyncingServer, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    isBlackList = "(&lt;NSAttributeDescription: 0x141048860&gt;), name isBlackList, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isBlackList, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    isLetvBindDeviceContact = "(&lt;NSAttributeDescription: 0x1410488f0&gt;), name isLetvBindDeviceContact, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isLetvBindDeviceContact, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    isLetvContact = "(&lt;NSAttributeDescription: 0x141048980&gt;), name isLetvContact, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isLetvContact, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    isRemovedFromAddressBook = "(&lt;NSAttributeDescription: 0x141048a10&gt;), name isRemovedFromAddressBook, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isRemovedFromAddressBook, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    isShouldDelete = "(&lt;NSAttributeDescription: 0x141048aa0&gt;), name isShouldDelete, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isShouldDelete, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    isVIPContact = "(&lt;NSAttributeDescription: 0x141048b30&gt;), name isVIPContact, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier isVIPContact, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 800 , attributeValueClassName NSNumber, defaultValue (null)";</div><div class="line">    "is_voip_number" = "(&lt;NSAttributeDescription: 0x141048bc0&gt;), name is_voip_number, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier is_voip_number, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    lastConnectDate = "(&lt;NSAttributeDescription: 0x141048c50&gt;), name lastConnectDate, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier lastConnectDate, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 900 , attributeValueClassName NSDate, defaultValue (null)";</div><div class="line">    letvAccountPhoneNumber = "(&lt;NSAttributeDescription: 0x141048ce0&gt;), name letvAccountPhoneNumber, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier letvAccountPhoneNumber, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    letvPicture = "(&lt;NSAttributeDescription: 0x141048d70&gt;), name letvPicture, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier letvPicture, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    letvUserName = "(&lt;NSAttributeDescription: 0x141048e00&gt;), name letvUserName, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier letvUserName, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    nameFirstChar = "(&lt;NSAttributeDescription: 0x141048e90&gt;), name nameFirstChar, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier nameFirstChar, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    nickname = "(&lt;NSAttributeDescription: 0x141048f20&gt;), name nickname, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier nickname, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    nonHometimePhoneNumbers = "(&lt;NSAttributeDescription: 0x141048fb0&gt;), name nonHometimePhoneNumbers, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier nonHometimePhoneNumbers, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    phoneNumberInAddressBookCheckExistResultType = "(&lt;NSAttributeDescription: 0x141049040&gt;), name phoneNumberInAddressBookCheckExistResultType, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier phoneNumberInAddressBookCheckExistResultType, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 100 , attributeValueClassName NSNumber, defaultValue 0";</div><div class="line">    "phone_number" = "(&lt;NSAttributeDescription: 0x1410490d0&gt;), name phone_number, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier phone_number, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    remarkName = "(&lt;NSAttributeDescription: 0x141049160&gt;), name remarkName, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier remarkName, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    sourceID = "(&lt;NSAttributeDescription: 0x1410491f0&gt;), name sourceID, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier sourceID, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">    syncStatus = "(&lt;NSAttributeDescription: 0x141049280&gt;), name syncStatus, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier syncStatus, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 100 , attributeValueClassName NSNumber, defaultValue 0";</div><div class="line">    telephoneNumbers = "(&lt;NSAttributeDescription: 0x141049310&gt;), name telephoneNumbers, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier telephoneNumbers, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, attributeType 700 , attributeValueClassName NSString, defaultValue (null)";</div><div class="line">&#125;</div><div class="line">(lldb) </div><div class="line"></div><div class="line"></div><div class="line">Printing description of relationships:</div><div class="line">&#123;</div><div class="line">    belongGroups = "(&lt;NSRelationshipDescription: 0x14104a0f0&gt;), name belongGroups, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier belongGroups, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmGroupEntity, inverseRelationship hasContacts, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">    hasBindDevices = "(&lt;NSRelationshipDescription: 0x14104a1a0&gt;), name hasBindDevices, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hasBindDevices, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmBindDeviceEntity, inverseRelationship belongContacts, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">    hasCalleeRecords = "(&lt;NSRelationshipDescription: 0x14104a250&gt;), name hasCalleeRecords, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hasCalleeRecords, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmCallRecordEntity, inverseRelationship belongCalleeContact, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">    hasCallerRecords = "(&lt;NSRelationshipDescription: 0x14104a300&gt;), name hasCallerRecords, isOptional 1, isTransient 0, entity HTmContactEntity, renamingIdentifier hasCallerRecords, validation predicates (<span class="symbol">\n</span>), warnings (<span class="symbol">\n</span>), versionHashModifier (null)<span class="symbol">\n</span> userInfo &#123;<span class="symbol">\n</span>&#125;<span class="symbol">\n</span>, destination entity HTmCallRecordEntity, inverseRelationship belongCallerContact, minCount 0, maxCount 0, isOrdered 0, deleteRule 1";</div><div class="line">&#125;</div><div class="line">(lldb) </div><div class="line"></div><div class="line"></div><div class="line">(lldb) po rel</div><div class="line">belongGroups</div><div class="line"></div><div class="line">(lldb) po hasLoopThroughRelationshipDescription</div><div class="line">0x000000016e892478</div><div class="line"></div><div class="line">(lldb) po *hasLoopThroughRelationshipDescription</div><div class="line">&lt;__NSArrayM 0x1411da430&gt;(</div><div class="line">belongGroups,</div><div class="line">hasBindDevices,</div><div class="line">hasCalleeRecords,</div><div class="line">belongCalleeContact</div><div class="line">)</div></pre></td></tr></table></figure>
<h5 id="CoreData的内存策略-fault"><a href="#CoreData的内存策略-fault" class="headerlink" title="CoreData的内存策略(fault)"></a>CoreData的内存策略(fault)</h5><p><a href="http://stackoverflow.com/questions/7304257/coredata-error-data-fault" target="_blank" rel="external">Coredata Error “ data: fault ”</a></p>
<p><a href="https://code.tutsplus.com/tutorials/what-is-a-core-data-fault--cms-25157" target="_blank" rel="external">What Is a Core Data Fault?</a></p>
<p>Entity不能跨线程使用(特别是修改)，否则：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="number">2016</span><span class="number">-10</span><span class="number">-24</span> <span class="number">11</span>:<span class="number">47</span>:<span class="number">25.864</span> HomeTime[<span class="number">8345</span>:<span class="number">5086261</span>] CRASH: CoreData could not fulfill a fault <span class="keyword">for</span> <span class="string">'0xd000000000040002 &lt;x-coredata://FB88D6DC-A39B-4590-8A7F-4BC8A53F4E24/HTmContactEntity/p1&gt;'</span></div><div class="line"></div><div class="line">Stack trace:</div><div class="line"><span class="meta">#0  CoreFoundation                      000000000183192DB0 &lt;redacted&gt;()</span></div><div class="line"><span class="meta">#1  libobjc.A.dylib                     0000000001827F7F80 objc_exception_throw()</span></div><div class="line"><span class="meta">#2  CoreData                            00000000018500C750 &lt;redacted&gt;()</span></div><div class="line"><span class="meta">#3  CoreData                            00000000018501C8C4 &lt;redacted&gt;()</span></div><div class="line"><span class="meta">#4  CoreData                            00000000018501C610 &lt;redacted&gt;()</span></div><div class="line"><span class="meta">#5  HomeTime                            000000000100136398 __87-[HTmLocalContactManager request_query_letvAccountInfoForPhoneNumbers:success:failure:]_block_invoke.458()</span></div><div class="line"><span class="meta">#6  CoreFoundation                      000000000183184F58 &lt;redacted&gt;()</span></div><div class="line"><span class="meta">#7  HomeTime                            000000000100135384 __87-[HTmLocalContactManager request_query_letvAccountInfoForPhoneNumbers:success:failure:]_block_invoke_2.409()</span></div><div class="line"><span class="meta">#8  CAbstractManager                    000000000101B10E9C -[BusinessBlockOperation main]</span></div><div class="line"><span class="meta">#9  Foundation                          000000000183A8EE48 -[__NSOperationInternal _start:]</span></div><div class="line"><span class="meta">#10 Foundation                          000000000183B4E934 &lt;redacted&gt;()</span></div><div class="line"><span class="meta">#11 libdispatch.dylib                   000000000101B75A3C _dispatch_client_callout()</span></div><div class="line"><span class="meta">#12 libdispatch.dylib                   000000000101B82554 _dispatch_queue_drain()</span></div><div class="line"><span class="meta">#13 libdispatch.dylib                   000000000101B7972C _dispatch_queue_invoke()</span></div><div class="line"><span class="meta">#14 libdispatch.dylib                   000000000101B8466C _dispatch_root_queue_drain()</span></div><div class="line"><span class="meta">#15 libdispatch.dylib                   000000000101B84364 _dispatch_worker_thread3()</span></div><div class="line"><span class="meta">#16 libsystem_pthread.dylib             000000000182DF5470 _pthread_wqthread()</span></div><div class="line"><span class="meta">#17 libsystem_pthread.dylib             000000000182DF5020 start_wqthread())</span></div><div class="line"><span class="number">2016</span><span class="number">-10</span><span class="number">-24</span> <span class="number">11</span>:<span class="number">47</span>:<span class="number">25.864</span> HomeTime[<span class="number">8345</span>:<span class="number">5086261</span>] *** Terminating app due to uncaught exception <span class="string">'NSObjectInaccessibleException'</span>, reason: <span class="string">'CoreData could not fulfill a fault for '</span><span class="number">0xd000000000040002</span> &lt;x-coredata:<span class="comment">//FB88D6DC-A39B-4590-8A7F-4BC8A53F4E24/HTmContactEntity/p1&gt;''</span></div><div class="line">*** First throw call stack:</div><div class="line">(<span class="number">0x183192db0</span> <span class="number">0x1827f7f80</span> <span class="number">0x18500c750</span> <span class="number">0x18501c8c4</span> <span class="number">0x18501c610</span> <span class="number">0x100136398</span> <span class="number">0x183184f58</span> <span class="number">0x100135384</span> <span class="number">0x101b10e9c</span> <span class="number">0x183a8ee48</span> <span class="number">0x183b4e934</span> <span class="number">0x101b75a3c</span> <span class="number">0x101b82554</span> <span class="number">0x101b7972c</span> <span class="number">0x101b8466c</span> <span class="number">0x101b84364</span> <span class="number">0x182df5470</span> <span class="number">0x182df5020</span>)</div><div class="line">libc++abi.dylib: terminating with uncaught exception of type _NSCoreDataException</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<p>Coredata Error “data: <fault>”<br><a href="http://stackoverflow.com/questions/7304257/coredata-error-data-fault" target="_blank" rel="external">http://stackoverflow.com/questions/7304257/coredata-error-data-fault</a></fault></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[request setReturnsObjectsAsFaults:NO]</div></pre></td></tr></table></figure>
<p>This is expected behaviour, core data won’t return full objects until you need to access the persistent values of the objects. Each of your returned objects will be a ‘fault’ until this point.</p>
<p>You can force the fetch request to return full objects using [request setReturnsObjectsAsFaults:NO], but in most cases what you have will be fine. Look at the documentation for NSFetchRequest for more information.</p>
<p>If you access one of the properties, core data will go to the persistent store and fetch the rest of your values, then you’ll get the full description in the logs.</p>
<p>This seems to be such a common misunderstanding that I decided to write about it, here.</p>
<p>“Core Data could not fulfill a fault” for objects that were created in the appDelegate managedObjectContext on the main thread<br><a href="http://stackoverflow.com/questions/20006689/core-data-could-not-fulfill-a-fault-for-objects-that-were-created-in-the-appde" target="_blank" rel="external">http://stackoverflow.com/questions/20006689/core-data-could-not-fulfill-a-fault-for-objects-that-were-created-in-the-appde</a></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">HTmLocalContactManager.m</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">     CoreData使用特别注意</div><div class="line">     1、每个NSThread实例，必须有各自的NSManagedObjectContext实例，该Context实际上是把db.sqlite文件读取到内存中。</div><div class="line">     2、CoreData的数据库实体（即 Entity，继承自NSManagedObject），存在于各自所属NSThread实例的NSManagedObjectContext实例中，并且Entity 不能 跨线程传递；如果 一定要 跨线程 传递Entity，请传递该Entity的主键(比如 myEntity.entityUUID)，然后在 另一个线程 使用 myEntity.entityUUID 从这个所谓 另一个线程 的Context，查找到这个Entity。</div><div class="line">     3、临时Entity数据，即 不打算 持久化的Entity，请使用 临时的Context，并且一定不能 [临时Context save]</div><div class="line">     4、Entity深拷贝？上面链接有。</div><div class="line">     5、CoreData 数据库迁移？CoreData 关系建立与移除？上面链接有。</div><div class="line">     */</div><div class="line">    __block <span class="built_in">NSMutableArray</span>&lt;HTmContactEntity*&gt; *oldHomeTimePersons;</div><div class="line">    __block <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSDictionary</span>*&gt; *newestHomeTimePersons;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//请求查询前，先缓存上次启动保存到数据库的联系人信息</span></div><div class="line"><span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;<span class="comment">//[begin] 没错，使用 同步 dispatch_sync</span></div><div class="line">	<span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">	<span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">		oldHomeTimePersons = (<span class="built_in">NSMutableArray</span> *)[<span class="keyword">self</span> allHomeTimeContacts];</div><div class="line">		<span class="built_in">NSLog</span>(<span class="string">@"oldHomeTimePersons number %ld"</span>, [oldHomeTimePersons count]);</div><div class="line">	&#125;);</div><div class="line">&#125;);<span class="comment">//[end] 没错，使用 同步 dispatch_sync</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*  oldHomeTimePersons 元素是  CoreData的数据库实体 ——&gt;  不能 “跨线程 修改”。 */</span></div><div class="line"></div><div class="line"></div><div class="line">用这个 把 代码，包围起来。</div><div class="line"></div><div class="line">&#123;<span class="comment">//CoreData数据库中 把原来支持现在变为不支持hometime联系人标记出来 --- begin ---//</span></div><div class="line"><span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;<span class="comment">//[begin]没错，使用 同步 dispatch_sync。因为：CoreData的数据库实体Entity不能跨线程使用，而oldHomeTimePersons是在主线程创建的，所以 必须在 主线程修改oldHomeTimePersons。</span></div><div class="line"></div><div class="line">&#125;);<span class="comment">//[end]没错，使用 同步 dispatch_sync</span></div><div class="line">&#125;<span class="comment">//CoreData数据库中 把原来支持现在变为不支持hometime联系人标记出来  --- end ---//</span></div></pre></td></tr></table></figure>
<p>上述代码<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">	<span class="comment">// 一些在主线程 操作数据库的代码</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>改成<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">BusinessBlockOperation </span>*<span class="keyword">blockOp </span>= [<span class="keyword">BusinessBlockOperation </span><span class="keyword">blockOperationWithBlock:^&#123;</span></div><div class="line"></div><div class="line">	// some <span class="meta">code</span></div><div class="line"></div><div class="line">&#125;]<span class="comment">;// blockOp</span></div><div class="line"></div><div class="line">[[[<span class="keyword">BusinessManager </span>sharedManager] localContactManager].serialOperationQueue <span class="keyword">addOperation:blockOp];</span></div></pre></td></tr></table></figure></p>
<p>更为合理。</p>
<h5 id="CoreData性能优化"><a href="#CoreData性能优化" class="headerlink" title="CoreData性能优化"></a>CoreData性能优化</h5><p>指定字段<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="comment">//&lt;---优化查找--begin---&gt;//</span></div><div class="line">	<span class="comment">// 指定 返回类型</span></div><div class="line">	fetchRequest.resultType = <span class="built_in">NSDictionaryResultType</span>;</div><div class="line">	<span class="comment">// 指定 查找字段</span></div><div class="line">	[fetchRequest setPropertiesToFetch:[<span class="built_in">NSArray</span> arrayWithObjects:<span class="string">@"entityUUID"</span>,<span class="string">@"telephoneNumbers"</span>, <span class="literal">nil</span>]];</div><div class="line">&#125;<span class="comment">//&lt;---优化查找--end---&gt;//</span></div></pre></td></tr></table></figure></p>
<p>数据分页</p>
<p>线程池中，并发数量 控制 (使用 操作队列)</p>
<p>在<strong>主线程</strong>操作数据库 ——&gt; 不可避免有这样的场景，数据量很小(三五条数据)。 </p>
<p>其他情况，批量写入数据库，都在 worker 线程。——&gt;  这样的worker 线程，只有3个(太多导致 context增多，同时context合并数据 也耗性能)。</p>
<p>问题：以后<strong>数据越来越多</strong>，问题就明显了 ？——&gt; 不会，因为：必须有一个 主线程的Context，而 Context的内存策略是 fault（这个不会 阻塞 线程 很久；如果数据量很大，使用 worker线程，不要用主线程）。</p>
<h5 id="CoreData-NSFetchedResultsController"><a href="#CoreData-NSFetchedResultsController" class="headerlink" title="CoreData + NSFetchedResultsController"></a>CoreData + NSFetchedResultsController</h5><p>NSFetchedResultsController 通过KVO/Notification模式，在一个线程(一般是主线程) 观察CoreData的一个NSManagedObjectContext(一般是主线程的Context)的变化(增、删、改)，定义一个NSFetchRequest将数据(包括数据的增删改)通过delegate模式绑定到view(一般是tableView 或 collectionView)。</p>
<p>具体做法，这里 <a href="https://itunes.apple.com/cn/course/id1104579961" target="_blank" rel="external">Stanford公开课-iOS9-Swift-第10课 Core Data</a> 和 这里 <a href="https://itunes.apple.com/cn/course/id733644550" target="_blank" rel="external">Stanford公开课-iOS7-ObjectiveC-第13课 Core Data and Tale View</a> ,  Stanford(美国斯坦福大学)的iOS开发公开课 <a href="https://HawkingOuYang.github.io/2016/07/12/9_iOS-Study-Lectures-Docs/">下载方式在这</a> , Stanford的官网下载代码：<a href="http://web.stanford.edu/class/cs193p/cgi-bin/drupal/" target="_blank" rel="external">cs193p iPhone App Dev</a> 和 <a href="http://web.stanford.edu/class/cs193p/cgi-bin/drupal/downloads-2013-fall" target="_blank" rel="external">cs193p iPhone App Dev downloads-2013-fall</a> </p>
<h5 id="做framework的脚本"><a href="#做framework的脚本" class="headerlink" title="做framework的脚本"></a>做framework的脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/bin/bash -e -x</span></div><div class="line"></div><div class="line">PROJECT_NAME=CCoreData</div><div class="line">SRCROOT=<span class="variable">$PWD</span></div><div class="line"></div><div class="line"><span class="comment"># 来源Ref. http://years.im/Home/Article/detail/id/52.html</span></div><div class="line"></div><div class="line"><span class="comment"># Sets the target folders and the final framework product.</span></div><div class="line"><span class="comment"># 如果工程名称和Framework的Target名称不一样的话，要自定义FMKNAME</span></div><div class="line"><span class="comment"># 例如: FMK_NAME = "MyFramework"</span></div><div class="line">FMK_NAME=<span class="variable">$&#123;PROJECT_NAME&#125;</span></div><div class="line"></div><div class="line"><span class="comment"># Install dir will be the final output to the framework.</span></div><div class="line"><span class="comment"># The following line create it in the root folder of the current project.</span></div><div class="line"></div><div class="line"><span class="comment">#$&#123;FMK_NAME&#125;.framework</span></div><div class="line"></div><div class="line"><span class="comment">#CONFIG=Debug </span></div><div class="line">CONFIG=Release</div><div class="line"></div><div class="line"><span class="comment"># Working dir will be deleted after the framework creation.</span></div><div class="line">WRK_DIR=build</div><div class="line">DEVICE_DIR=<span class="variable">$&#123;WRK_DIR&#125;</span>/<span class="variable">$&#123;CONFIG&#125;</span>-iphoneos/<span class="variable">$&#123;FMK_NAME&#125;</span>.framework</div><div class="line">SIMULATOR_DIR=<span class="variable">$&#123;WRK_DIR&#125;</span>/<span class="variable">$&#123;CONFIG&#125;</span>-iphonesimulator/<span class="variable">$&#123;FMK_NAME&#125;</span>.framework</div><div class="line">INSTALL_DIR=<span class="variable">$&#123;SRCROOT&#125;</span>/Products/</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Clean and Building both architectures.</span></div><div class="line">xcodebuild -configuration <span class="variable">$CONFIG</span> -target <span class="string">"<span class="variable">$&#123;FMK_NAME&#125;</span>"</span> -project CCoreData.xcodeproj -sdk iphoneos build </div><div class="line">xcodebuild -configuration <span class="variable">$CONFIG</span> -target <span class="string">"<span class="variable">$&#123;FMK_NAME&#125;</span>"</span> -project CCoreData.xcodeproj -sdk iphonesimulator build</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Cleaning the oldest.</span></div><div class="line"><span class="keyword">if</span> [ <span class="_">-d</span> <span class="string">"<span class="variable">$&#123;INSTALL_DIR&#125;</span>"</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    rm -rf <span class="string">"<span class="variable">$&#123;INSTALL_DIR&#125;</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">mkdir -p <span class="string">"<span class="variable">$&#123;INSTALL_DIR&#125;</span>"</span></div><div class="line"></div><div class="line">cp -r <span class="string">"<span class="variable">$&#123;DEVICE_DIR&#125;</span>"</span> <span class="string">"<span class="variable">$INSTALL_DIR</span>"</span></div><div class="line"></div><div class="line"><span class="comment"># Uses the Lipo Tool to merge both binary files (i386 + armv6/armv7) into one Universal final product.</span></div><div class="line">lipo -create <span class="string">"<span class="variable">$&#123;DEVICE_DIR&#125;</span>/<span class="variable">$&#123;FMK_NAME&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;SIMULATOR_DIR&#125;</span>/<span class="variable">$&#123;FMK_NAME&#125;</span>"</span> -output <span class="string">"<span class="variable">$&#123;INSTALL_DIR&#125;</span>/<span class="variable">$&#123;FMK_NAME&#125;</span>.framework/<span class="variable">$&#123;FMK_NAME&#125;</span>"</span></div><div class="line"></div><div class="line"><span class="comment"># rm -r "$&#123;WRK_DIR&#125;"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"done."</span></div><div class="line"></div><div class="line">open <span class="string">"<span class="variable">$&#123;INSTALL_DIR&#125;</span>"</span></div></pre></td></tr></table></figure>
<h5 id="CCoreData-framework-CAbstractManager-framework"><a href="#CCoreData-framework-CAbstractManager-framework" class="headerlink" title="CCoreData.framework + CAbstractManager.framework"></a>CCoreData.framework + CAbstractManager.framework</h5><p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1031-4.png" alt=""></p>
<p>基于Apple的 <em> CoreData.framework </em> ，根据CoreData的线程安全、多线程数据合并、数据库迁移、关系型数据 等特点，使用Objective-C，封装成为 <em> CCoreData.framework </em>。</p>
<p>基于｀工厂模式｀，｀单例模式｀，｀多线程并发｀ ，｀通知＋block 进行线程通讯｀，｀GCD + Operation Queue｀ 等，并依赖于CoreData的线程安全、多线程数据合并(即自己封装的 <em> CCoreData.framework </em> )，使用Objective-C，封装成为 <em> CAbstractManager.framework </em> 。</p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/CAbstractManager_CCoreData_Frameworks_files_1.png" alt=""></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/CAbstractManager_CCoreData_Frameworks_files_2.png" alt=""></p>
<p>App Store Review 需要支持bitcode，所以自己造的framework也得支持bitcode，那么，修改工程配置的bitcode为YES，如下图：</p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/AppStoreReview_bitCodeSupport_Required.png" alt=""></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/CAbstractManager_framework_bitCodeSupport.png" alt=""></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/CCoreData_framework_bitCodeSupport.png" alt=""></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="built_in">CAbstractManager</span>.framework/<span class="built_in">CAbstractManagerDefine</span>.h</div><div class="line"><span class="comment">/**</span></div><div class="line"> @brief 线程最大运行个数</div><div class="line"> @attention 请勿在其他地方 重复定义｀此常量｀</div><div class="line"> @note ｀此常量｀的含义为：AbstractManager的'操作队列' 线程并发操作数</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSInteger</span> <span class="keyword">const</span> MY_THREAD_CONCURRENT_OPERATION_COUNT  =  <span class="number">3</span> ;</div></pre></td></tr></table></figure>
<p>by OYXJ thinking carefully at night on 2016.10.26, and in the morning on 2016.10.27,<br>resulting in a conclusion that:</p>
<p>change <strong>MY_THREAD_CONCURRENT_OPERATION_COUNT</strong> after —&gt; CAbstractManager.framework is complied into “Unix executable” file named “CAbstractManager”, WON’T re-compile CAbstractManager, thus the effort of trying changing MY_THREAD_CONCURRENT_OPERATION_COUNT does not work.</p>
<p>so, revert back to AS IS.</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CAbstractManager.framework/CAbstractManager<span class="selector-class">.h</span></div><div class="line"></div><div class="line"><span class="selector-id">#import</span> &lt;CAbstractManager/AbstractManager.h&gt;		<span class="comment">//注意这里的顺序，项目中实际应用，编译报错了。</span></div><div class="line"><span class="selector-id">#import</span> &lt;CAbstractManager/CAbstractManagerDefine.h&gt;	<span class="comment">//注意这里的顺序，项目中实际应用，编译报错了。</span></div><div class="line"><span class="selector-id">#import</span> &lt;CAbstractManager/BusinessBlockOperation.h&gt;</div><div class="line"><span class="selector-id">#import</span> &lt;CAbstractManager/BusinessSelectorOperation.h&gt;</div></pre></td></tr></table></figure>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">➜  ~ git:(文稿+音乐) ✗ cd  CustomFramework/WebRTC.framework</div><div class="line">➜  WebRTC.framework git:(文稿+音乐) ✗ l</div><div class="line">total 19272</div><div class="line">drwxr-xr-x  <span class="number"> 7 </span>OYXJ  staff   238B<span class="number"> 10 </span>21 13:21 .</div><div class="line">drwxr-xr-x@ <span class="number"> 9 </span>OYXJ  staff   306B<span class="number"> 10 </span>27 10:06 ..</div><div class="line">-rw-r--r--@ <span class="number"> 1 </span>OYXJ  staff   6.0K<span class="number"> 10 </span>21 13:22 .DS_Store</div><div class="line">drwxr-xr-x <span class="number"> 37 </span>OYXJ  staff   1.2K <span class="number"> 9 </span>19 12:04 Headers</div><div class="line">-rw-r--r--  <span class="number"> 1 </span>OYXJ  staff   778B<span class="number"> 10 </span>14 01:05 Info.plist</div><div class="line">drwxr-xr-x  <span class="number"> 3 </span>OYXJ  staff   102B <span class="number"> 9 </span>19 12:04 Modules</div><div class="line">-rwxr-xr-x  <span class="number"> 1 </span>OYXJ  staff   9.4M<span class="number"> 10 </span>14 01:05 WebRTC</div></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">HTmSyncServerContactManager.m</span></div><div class="line"></div><div class="line">同步联系人：读、写 数据库的操作，放在 串行队列上，避免 多线程 写 数据库，导致 数据重复。</div><div class="line"><span class="symbol">.operationQueue</span> 变成 .serialOperationQueue </div><div class="line"></div><div class="line"><span class="symbol">#import</span> &lt;CAbstractManager/<span class="keyword">BusinessBlockOperation.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">BusinessBlockOperation </span>*<span class="keyword">blockOp </span>= [<span class="keyword">BusinessBlockOperation </span><span class="keyword">blockOperationWithBlock:^&#123;</span></div><div class="line"></div><div class="line">	// some <span class="meta">code</span></div><div class="line"></div><div class="line">&#125;]<span class="comment">;// blockOp</span></div><div class="line"></div><div class="line">[[<span class="keyword">BusinessManager </span>sharedManager].syncServerContactManager.operationQueue <span class="keyword">addOperation:blockOp];</span></div><div class="line"></div><div class="line">比如</div><div class="line">[[<span class="keyword">BusinessManager </span>sharedManager].syncServerContactManager.operationQueue <span class="keyword">addOperation:blockOp]</span></div><div class="line">变成</div><div class="line">[[<span class="keyword">BusinessManager </span>sharedManager].syncServerContactManager.serialOperationQueue <span class="keyword">addOperation:blockOp];</span></div></pre></td></tr></table></figure>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1031-5.png" alt=""></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1031-1.png" alt=""><br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1031-2.png" alt=""><br><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1031-3.png" alt=""></p>
<p>Base 查看沙盒 数据库，分享一<a href="http://7xpc28.com1.z0.glb.clouddn.com/Base249.dmg" target="_blank" rel="external">下</a>。</p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1101-1.png" alt=""></p>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton-1101-2.png" alt=""></p>
<h5 id="踩过的坑-amp-Debug"><a href="#踩过的坑-amp-Debug" class="headerlink" title="踩过的坑 &amp; Debug"></a>踩过的坑 &amp; Debug</h5><h6 id="CoreData-多个Context的数据同步"><a href="#CoreData-多个Context的数据同步" class="headerlink" title="CoreData 多个Context的数据同步"></a>CoreData 多个Context的数据同步</h6><p>以下数据，已经洗白，避免泄漏公司项目的关键信息。</p>
<p>多线程数据同步<br>对比<br>etag<br>sourceID<br>syncStatus</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line">特别说明：by OYXJ on 2016.11.02</div><div class="line">此处 此线程(简称线程A) 使用 此mAllLocalList内存数据(即 objContact.sourceID)，</div><div class="line">在此处之前或者之后 还有另一个线程(即[BusinessManager sharedManager].syncServerContactManager.serialOperationQueue)的线程(简称线程B)</div><div class="line">在写入 数据库，包括更改 mAllLocalList所引用的数据库实体(对应沙盒中持久化StoreFile的数据库Record)，</div><div class="line">但是 此文件中，并没有 把“线程B的context”更改、插入的数据 同步至 “线程A的context“ ---&gt; 目前来说，是不合理的、不正确的。</div><div class="line">所以  在 “线程B”更改、插入的数据 [线程B的context save]; 之后，需要在“线程A”，执行： [[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];</div><div class="line">*/</div><div class="line"></div><div class="line"></div><div class="line">// HTmContactEntity *contact = objContact;</div><div class="line">LELOGD(@"contactEtag---- before entityUUID = %@, nickname = %@  etag = %@   sorceid=%@",</div><div class="line">	objContact.entityUUID, objContact.nickname, objContact.etag, objContact.sourceID );</div><div class="line">[[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];</div><div class="line">// HTmContactEntity *contact1 = objContact;</div><div class="line">LELOGD(@"contactEtag---- after  entityUUID = %@, nickname = %@  etag=  %@   sorceid=%@",</div><div class="line">	objContact.entityUUID, objContact.nickname, objContact.etag, objContact.sourceID );</div><div class="line">                           </div><div class="line"></div><div class="line"></div><div class="line">(lldb) po mDumpID</div><div class="line">&lt;__NSArrayM 0x17445f530&gt;(</div><div class="line">B8ECCAEF<span class="string">-72</span>C8<span class="string">-422</span>C-B5A4<span class="string">-43</span>EBD0C19CA7,</div><div class="line">16635605<span class="string">-811</span>A<span class="string">-4</span>B3C-B287<span class="string">-105</span>AEDC4E07C,</div><div class="line">34497B8E<span class="string">-26</span>F7<span class="string">-469</span>C-AF02-C3AF3C850315,</div><div class="line">72D55B7E<span class="string">-880</span>A<span class="string">-4</span>FAE<span class="string">-8</span>D84<span class="string">-38</span>FA56EC6FDC,</div><div class="line">B11BE4EA<span class="string">-0</span>D89<span class="string">-422</span>F-B1C9-EB1C811568B4,</div><div class="line">7FE10CF1-B8C9<span class="string">-4</span>A72-A872<span class="string">-43</span>FDDED253D5,</div><div class="line">D36F6A52<span class="string">-0671</span><span class="string">-4</span>A7A-B321<span class="string">-984</span>F6D8D0FD3,</div><div class="line">4AE29811<span class="string">-6</span>D30<span class="string">-4</span>C06-B865-C0E0FEF3BE67,</div><div class="line">95F071E9-F538<span class="string">-4</span>BAA<span class="string">-8</span>F15<span class="string">-49</span>B513984CA7,</div><div class="line">685957E3-AA52<span class="string">-49</span>BA-B643-D7355F1F2FE5,</div><div class="line">9ADEFDD9-B995<span class="string">-4</span>E44<span class="string">-88</span>F9<span class="string">-0</span>B74770381BD,</div><div class="line">2E38B92F<span class="string">-9991</span><span class="string">-4</span>CFF-B2DB<span class="string">-5</span>FEC4F83DC2F</div><div class="line">)</div><div class="line"></div><div class="line"></div><div class="line">2016<span class="string">-11</span><span class="string">-02</span> 18:30:23:244 HomeTime[17319:3112341] LeNet.h:477 TaskHeartBeat(0x1aac2ac40)  hbElapse=10 status=logined last_recv_data_time=1478082570012 last_heart_beat_time=0 elapse_last_heart_beat=0 elapse_last_recv_data=53232 recv_heart_beat_timeused=0</div><div class="line">(lldb) po mAllLocalList.count</div><div class="line">12</div><div class="line"></div><div class="line">2016<span class="string">-11</span><span class="string">-02</span> 18:30:33.945822 HomeTime[17319:3112341] reportEvt:ext:2,pri:1</div><div class="line">2016<span class="string">-11</span><span class="string">-02</span> 18:30:23:244 HomeTime[17319:3112341] LeNet.h:658 LeNet.sendHeartBeat</div><div class="line">2016<span class="string">-11</span><span class="string">-02</span> 18:30:23:245 HomeTime[17319:3112341] LeNet.h:635 LeNet.send cmd=9 length=7</div><div class="line">(lldb) po objContact</div><div class="line">&lt;NSManagedObject: 0x1704c7d90&gt; (entity: HTmContactEntity; id: 0xd000000000200000 &lt;x-coredata://650B8F90<span class="string">-9</span>C0C<span class="string">-47</span>F0<span class="string">-9235</span>-EAF231E02CF5/HTmContactEntity/p8&gt; ; data: &#123;</div><div class="line">	nameFirstChar = 金;</div><div class="line">	hasCallerRecords = &lt;relationship fault: 0x1706277a0 'hasCallerRecords'&gt;;</div><div class="line">	isRemovedFromAddressBook = 0;</div><div class="line">	contactTypeBitmask = 1;</div><div class="line">	nickname = 欧阳孝金;</div><div class="line">	hasBindDevices = &lt;relationship fault: 0x170626040 'hasBindDevices'&gt;;</div><div class="line">	belongGroups = &lt;relationship fault: 0x1706249e0 'belongGroups'&gt;;</div><div class="line">	isAddedContactBySyncingServer = nil;</div><div class="line">	firstLetterSpell = oyxj;</div><div class="line">	phoneNumberInAddressBookCheckExistResultType = 2;</div><div class="line">	hasCalleeRecords = &lt;relationship fault: 0x1706280c0 'hasCalleeRecords'&gt;;</div><div class="line">	dataSourceType = 2;</div><div class="line">	foreignKeyAccountUserID = nil;</div><div class="line">	abRecordID = 381;</div><div class="line">	etag = nil;		//“线程B”更改此数据，然后[线程B的context save];</div><div class="line">	syncStatus = 1;		//“线程B”更改此数据, 然后[线程B的context save];</div><div class="line">	deviceID = nil;</div><div class="line">	sourceID = B8ECCAEF<span class="string">-72</span>C8<span class="string">-422</span>C-B5A4<span class="string">-43</span>EBD0C19CA7;</div><div class="line">	fullSpell = ouyangxiaojin;</div><div class="line">	entityUUID = B8ECCAEF<span class="string">-72</span>C8<span class="string">-422</span>C-B5A4<span class="string">-43</span>EBD0C19CA7;</div><div class="line">	isShouldDelete = 0;</div><div class="line">	colorHexValue = 16240213;</div><div class="line">&#125;</div><div class="line">)</div><div class="line"></div><div class="line">此前，断点调试,</div><div class="line">此处，执行这行代码，</div><div class="line">**[[BaseAccessor sharedBaseAccessor] mergeChangesManagedObjectsOnCurrentThread];**</div><div class="line">此后，接着 断点调试。</div><div class="line"></div><div class="line"></div><div class="line">(lldb) po objContact</div><div class="line">&lt;NSManagedObject: 0x1704c7d90&gt; (entity: HTmContactEntity; id: 0xd000000000200000 &lt;x-coredata://650B8F90<span class="string">-9</span>C0C<span class="string">-47</span>F0<span class="string">-9235</span>-EAF231E02CF5/HTmContactEntity/p8&gt; ; data: &lt;fault&gt;)</div><div class="line"></div><div class="line">(lldb) po objContact.entityUUID</div><div class="line">B8ECCAEF<span class="string">-72</span>C8<span class="string">-422</span>C-B5A4<span class="string">-43</span>EBD0C19CA7</div><div class="line"></div><div class="line">(lldb) po objContact</div><div class="line">&lt;NSManagedObject: 0x1704c7d90&gt; (entity: HTmContactEntity; id: 0xd000000000200000 &lt;x-coredata://650B8F90<span class="string">-9</span>C0C<span class="string">-47</span>F0<span class="string">-9235</span>-EAF231E02CF5/HTmContactEntity/p8&gt; ; data: &#123;</div><div class="line">	nameFirstChar = 金;</div><div class="line">	hasCallerRecords = &lt;relationship fault: 0x17043cf40 'hasCallerRecords'&gt;;</div><div class="line">	isRemovedFromAddressBook = 0;</div><div class="line">	contactTypeBitmask = 1;</div><div class="line">	nickname = 欧阳孝金;</div><div class="line">	hasBindDevices = &lt;relationship fault: 0x17042f700 'hasBindDevices'&gt;;</div><div class="line">	belongGroups = &lt;relationship fault: 0x17043d6a0 'belongGroups'&gt;;</div><div class="line">	isAddedContactBySyncingServer = nil;</div><div class="line">	firstLetterSpell = oyxj;</div><div class="line">	phoneNumberInAddressBookCheckExistResultType = 2;</div><div class="line">	hasCalleeRecords = &lt;relationship fault: 0x170238360 'hasCalleeRecords'&gt;;</div><div class="line">	dataSourceType = 2;</div><div class="line">	foreignKeyAccountUserID = nil;</div><div class="line">	abRecordID = 381;</div><div class="line">	etag = W/"675d32ae1439229aefaf949ae0cd1abe";		//“线程A”已经同步了“线程B”对数据的更改。</div><div class="line">	syncStatus = 0;						//“线程A”已经同步了“线程B”对数据的更改。</div><div class="line">	deviceID = nil;</div><div class="line">	sourceID = B8ECCAEF<span class="string">-72</span>C8<span class="string">-422</span>C-B5A4<span class="string">-43</span>EBD0C19CA7;</div><div class="line">	fullSpell = ouyangxiaojin;</div><div class="line">	entityUUID = B8ECCAEF<span class="string">-72</span>C8<span class="string">-422</span>C-B5A4<span class="string">-43</span>EBD0C19CA7;</div><div class="line">	isShouldDelete = 0;</div><div class="line">	colorHexValue = 16240213;</div><div class="line">&#125;</div><div class="line">)</div><div class="line"></div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSEntityDescription</span>搞错，导致KVO时崩溃。</div><div class="line"></div><div class="line">local_entityDesc这个东西搞错，local_clonedRelatedObject是个HTmCallRecordEntity，</div><div class="line">				但是local_entityDesc描述HTmContactEntity。</div><div class="line"></div><div class="line"><span class="built_in">NSEntityDescription</span> *local_entityDesc = [relatedObject entity]; </div><div class="line"><span class="built_in">NSManagedObject</span> *local_clonedRelatedObject = </div><div class="line">		[[<span class="built_in">NSManagedObject</span> alloc] initWithEntity: local_entityDesc</div><div class="line">         		insertIntoManagedObjectContext: *destinationEntityInsertContext];</div><div class="line"></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-02</span> <span class="number">22</span>:<span class="number">46</span>:<span class="number">26.787</span> HomeTime[<span class="number">1387</span>:<span class="number">409219</span>] CRASH: [&lt;<span class="built_in">NSManagedObject</span> <span class="number">0x13eecc8a0</span>&gt; setValue:forUndefinedKey:]: the entity HTmContactEntity is not key value coding-compliant <span class="keyword">for</span> the key <span class="string">"callee"</span>.</div></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">to-many 和 to-one 数据关系，克隆时，崩溃。</div><div class="line"></div><div class="line">2016-11-03 <span class="attribute">10</span>:<span class="number">39</span>:<span class="number">43.920</span> HomeTime[<span class="number">1454</span>:<span class="number">434979</span>] <span class="attribute">CRASH</span>: NSManagedObjects of entity <span class="string">'HTmCallRecordEntity'</span> do not support <span class="attribute">-mutableSetValueForKey</span>: for the property <span class="string">'belongCalleeContact'</span></div><div class="line"></div><div class="line">因为：</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：所属 Callee联系人 （to-one）</span></div><div class="line"><span class="variable">@property</span> (nonatomic, strong) HTmContactEntity *belongCalleeContact;</div><div class="line"></div><div class="line"><span class="comment">//! 数据关系：所属 Caller联系人 （to-one）</span></div><div class="line"><span class="variable">@property</span> (nonatomic, strong) HTmContactEntity *belongCallerContact;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line">调试信息：</div><div class="line"></div><div class="line">(lldb) po [[source <span class="attribute">valueForKey</span>:@<span class="string">"belongCalleeContact"</span>] class]</div><div class="line">NSManagedObject</div><div class="line"></div><div class="line">(lldb) po [[source <span class="attribute">mutableSetValueForKey</span>:@<span class="string">"belongCalleeContact"</span>]]</div><div class="line"><span class="attribute">error</span>: expected identifier</div><div class="line">(lldb) po [source <span class="attribute">mutableSetValueForKey</span>:@<span class="string">"belongCalleeContact"</span>]</div><div class="line"><span class="attribute">error</span>: Execution was interrupted, <span class="attribute">reason</span>: internal ObjC exception breakpoint(-<span class="number">3</span>)..</div><div class="line">The process has been returned to the state before expression evaluation.</div><div class="line">(lldb) po [[source <span class="attribute">mutableSetValueForKey</span>:@<span class="string">"belongCalleeContact"</span>] class]</div><div class="line"><span class="attribute">error</span>: Execution was interrupted, <span class="attribute">reason</span>: internal ObjC exception breakpoint(-<span class="number">3</span>)..</div><div class="line">The process has been returned to the state before expression evaluation.</div><div class="line">(lldb) </div><div class="line"></div><div class="line"><span class="comment">//to-one relationship OR to-many relationship</span></div><div class="line"><span class="comment">//- (nullable id)valueForKey:(NSString *)key;</span></div><div class="line">            </div><div class="line"><span class="comment">//to-many relationship</span></div><div class="line"><span class="comment">//- (NSMutableSet *)mutableSetValueForKey:(NSString *)key;</span></div></pre></td></tr></table></figure>
<p><img src="http://7xpc28.com1.z0.glb.clouddn.com/iOS-CoreData-MultiThreading-FactoryPattern-Singleton_kvo_dataRelationship_1107.png" alt=""></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">不同contexts之间的数据库实体Entity，企图建立“数据关系”，导致崩溃。</div><div class="line"></div><div class="line">*** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: 'Illegal attempt to establish a relationship 'belongCalleeContact' between objects <span class="keyword">in</span> different contexts</div><div class="line"></div><div class="line"></div><div class="line">Stack trace:</div><div class="line"><span class="comment">#0  CoreFoundation                      00000000018203ADB0 &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#1  libobjc.A.dylib                     00000000018169FF80 objc_exception_throw()</span></div><div class="line"><span class="comment">#2  CoreData                            000000000183EC5F80 &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#3  CoreData                            000000000183EC462C &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#4  CoreData                            000000000183ED2270 -[NSManagedObject _maintainInverseRelationship:forProperty:forChange:onSet:]</span></div><div class="line"><span class="comment">#5  CoreData                            000000000183ECE0E0 -[NSManagedObject _didChangeValue:forRelationship:named:withInverse:]</span></div><div class="line"><span class="comment">#6  Foundation                          000000000182937F64 &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#7  Foundation                          000000000182937A8C &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#8  Foundation                          00000000018299CBD8 -[NSObject didChangeValueForKey:withSetMutation:usingObjects:]</span></div><div class="line"><span class="comment">#9  CoreData                            000000000183ED20E8 -[NSManagedObject didChangeValueForKey:withSetMutation:usingObjects:]</span></div><div class="line"><span class="comment">#10 CoreData                            000000000183EF4D48 -[_NSNotifyingWrapperMutableSet addObject:]</span></div><div class="line"><span class="comment">#11 HomeTime                            000000000100193A88 +[BaseManagedObject p_cloneSourceEntity:inContext:intoDestinationEntity:ignoreAttributes:]</span></div><div class="line"><span class="comment">#12 HomeTime                            000000000100193030 +[BaseManagedObject cloneSourceEntity:intoDestinationEntity:ignoreAttributes:]</span></div><div class="line"><span class="comment">#13 HomeTime                            00000000010014AB34 -[HTmContactAccessor syncServerContact_insertOrUpdateContact:]</span></div><div class="line"><span class="comment">#14 HomeTime                            000000000100112ED8 -[HTmLocalContactManager syncServerContact_insertOrUpdateContact:]</span></div><div class="line"><span class="comment">#15 HomeTime                            0000000001001D1A94 __47-[HTmSyncServerContactManager p_pullNew:local:]_block_invoke_3()</span></div><div class="line"><span class="comment">#16 CoreFoundation                      000000000181F32584 &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#17 CoreFoundation                      000000000181F292D4 -[__NSArrayI enumerateObjectsWithOptions:usingBlock:]</span></div><div class="line"><span class="comment">#18 HomeTime                            0000000001001D1230 __47-[HTmSyncServerContactManager p_pullNew:local:]_block_invoke_2.1035()</span></div><div class="line"><span class="comment">#19 CAbstractManager                    000000000101B14B88 -[BusinessBlockOperation main]</span></div><div class="line"><span class="comment">#20 Foundation                          000000000182936E48 -[__NSOperationInternal _start:]</span></div><div class="line"><span class="comment">#21 Foundation                          0000000001829F6934 &lt;redacted&gt;()</span></div><div class="line"><span class="comment">#22 libdispatch.dylib                   000000000101B61A3C _dispatch_client_callout()</span></div><div class="line"><span class="comment">#23 libdispatch.dylib                   000000000101B6E554 _dispatch_queue_drain()</span></div><div class="line"><span class="comment">#24 libdispatch.dylib                   000000000101B6572C _dispatch_queue_invoke()</span></div><div class="line"><span class="comment">#25 libdispatch.dylib                   000000000101B7066C _dispatch_root_queue_drain()</span></div><div class="line"><span class="comment">#26 libdispatch.dylib                   000000000101B70364 _dispatch_worker_thread3()</span></div><div class="line"><span class="comment">#27 libsystem_pthread.dylib             000000000181C9D470 _pthread_wqthread()</span></div><div class="line"><span class="comment">#28 libsystem_pthread.dylib             000000000181C9D020 start_wqthread())</span></div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">03</span> <span class="number">11</span>:<span class="number">52</span>:<span class="number">01.538</span> HomeTime[<span class="number">1508</span>:<span class="number">449017</span>] *** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: 'Illegal attempt to establish a relationship 'belongCalleeContact' between objects <span class="keyword">in</span> different contexts (<span class="attr">source</span> = &lt;NSManagedObject: <span class="number">0</span>x15d90da50&gt; (entity: HTmCallRecordEntity; id: <span class="number">0</span>x15d93dd80 &lt;x-coredata:///HTmCallRecordEntity/t4DF25175-A3C3-<span class="number">489</span>A-AF24-<span class="number">6</span>E661B4175C119&gt; ; data: &#123;</div><div class="line">	<span class="attr">oppositeName</span> = 😄Aaa;</div><div class="line">	<span class="attr">isCalleeTalk</span> = nil;</div><div class="line">	<span class="attr">isOppositeDeviceSelf</span> = nil;</div><div class="line">	<span class="attr">oppositeFirstLetterSpell</span> = A;</div><div class="line">	<span class="attr">oppositeContactEntityUUID</span> = FD8B75F0-<span class="number">92</span>D4-<span class="number">4</span>AB0-A19B-<span class="number">59</span>D14F194B55;</div><div class="line">	<span class="attr">callee</span> = <span class="number">13661248236</span>;</div><div class="line">	<span class="attr">tsTalk</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">inviteTimeIntervalToLocalDate</span> = <span class="number">2016</span>-<span class="number">11</span>-<span class="number">02</span> <span class="number">09</span>:<span class="number">01</span>:<span class="number">15</span> +<span class="number">0000</span>;</div><div class="line">	<span class="attr">oppositeColorHexValue</span> = <span class="number">6675144</span>;</div><div class="line">	<span class="attr">oppositePhoneNumberLocation</span> = 北京;</div><div class="line">	<span class="attr">calleeName</span> = 😄Aaa;</div><div class="line">	<span class="attr">oppositeDeviceID</span> = nil;</div><div class="line">	<span class="attr">indexYearMonth</span> = <span class="number">2016</span>年<span class="number">11</span>月;</div><div class="line">	<span class="attr">oppositePhoneNumberInAddressBookCheckExistResultType</span> = <span class="number">2</span>;</div><div class="line">	<span class="attr">isCallerInvite</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">type</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">calleeDevice</span> = --<span class="number">861579030062526</span>;</div><div class="line">	<span class="attr">belongCallerContact</span> = nil;</div><div class="line">	<span class="attr">googRemoteAddress</span> = ;</div><div class="line">	<span class="attr">foreignKeyAccountUserID</span> = <span class="number">107182627797</span>;</div><div class="line">	<span class="attr">callerDevice</span> = <span class="number">2818</span>C121-<span class="number">9048</span>-<span class="number">4</span>D64-B7D0-EDD7CE191529;</div><div class="line">	<span class="attr">oppositeIndexMark</span> = A;</div><div class="line">	<span class="attr">talkTimeIntervalToLocalDate</span> = nil;</div><div class="line">	<span class="attr">googLocalAddress</span> = ;</div><div class="line">	<span class="attr">isCalleeInvite</span> = nil;</div><div class="line">	<span class="attr">isOppositeHomeTimePhoneNumber</span> = nil;</div><div class="line">	<span class="attr">oppositeHeadIconPath</span> = FD8B75F0-<span class="number">92</span>D4-<span class="number">4</span>AB0-A19B-<span class="number">59</span>D14F194B55.jpeg;</div><div class="line">	<span class="attr">tsInviteOver</span> = <span class="number">608526972</span>;</div><div class="line">	<span class="attr">oppositeNameFirstChar</span> = A;</div><div class="line">	<span class="attr">isCallerTalk</span> = nil;</div><div class="line">	<span class="attr">traceError</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">callerNameFirstChar</span> = 金;</div><div class="line">	<span class="attr">sessionId</span> = <span class="number">69910</span>CFD-<span class="number">956</span>D-<span class="number">4421</span>-<span class="number">8</span>CD0-<span class="number">422957527890</span>;</div><div class="line">	<span class="attr">belongCalleeContact</span> = nil;</div><div class="line">	<span class="attr">isShouldDelete</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">inviteDurationSeconds</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">callerName</span> = 欧阳孝金;</div><div class="line">	<span class="attr">talkDurationSeconds</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">isCaller</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">googRemoteCandidateType</span> = ;</div><div class="line">	<span class="attr">isPullFromServer</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">entityUUID</span> = nil;</div><div class="line">	<span class="attr">tsInvite</span> = <span class="number">608525822</span>;</div><div class="line">	<span class="attr">tsTalkOver</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">isVoiceCall</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">googLocalCandidateType</span> = ;</div><div class="line">	<span class="attr">oppositeFullSpell</span> = Aaa;</div><div class="line">	<span class="attr">calleeNameFirstChar</span> = A;</div><div class="line">	<span class="attr">isIllegal</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">oppositeDeviceType</span> = <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">) , <span class="attr">destination</span> = &lt;NSManagedObject: <span class="number">0</span>x15df7a530&gt; (entity: HTmContactEntity; id: <span class="number">0</span>xd000000000640004 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmContactEntity/p25&gt; ; data: &#123;</div><div class="line">	<span class="attr">nameFirstChar</span> = A;</div><div class="line">	<span class="attr">hasCallerRecords</span> = &lt;relationship fault: <span class="number">0</span>x15d901270 'hasCallerRecords'&gt;;</div><div class="line">	<span class="attr">isRemovedFromAddressBook</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">data_5</span> = nil;</div><div class="line">	<span class="attr">contactTypeBitmask</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">isVIPContact</span> = nil;</div><div class="line">	<span class="attr">data_4</span> = nil;</div><div class="line">	<span class="attr">nickname</span> = Aaa;</div><div class="line">	<span class="attr">hasBindDevices</span> = (</div><div class="line">);</div><div class="line">	<span class="attr">blackListPhoneNumbers</span> = nil;</div><div class="line">	<span class="attr">data_3</span> = nil;</div><div class="line">	<span class="attr">belongGroups</span> = (</div><div class="line">);</div><div class="line">	<span class="attr">isAddedContactBySyncingServer</span> = nil;</div><div class="line">	<span class="attr">firstLetterSpell</span> = A;</div><div class="line">	<span class="attr">phoneNumberInAddressBookCheckExistResultType</span> = <span class="number">2</span>;</div><div class="line">	<span class="attr">data_2</span> = nil;</div><div class="line">	<span class="attr">hasCalleeRecords</span> = (</div><div class="line">	<span class="number">0</span>xd000000000200002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p8&gt;,</div><div class="line">	<span class="number">0</span>x15d93dd80 &lt;x-coredata:///HTmCallRecordEntity/t4DF25175-A3C3-<span class="number">489</span>A-AF24-<span class="number">6</span>E661B4175C119&gt;,</div><div class="line">	<span class="number">0</span>xd000000000080002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p2&gt;,</div><div class="line">	<span class="number">0</span>xd000000000280002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p10&gt;,</div><div class="line">	<span class="number">0</span>xd000000000300002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p12&gt;,</div><div class="line">	<span class="number">0</span>xd0000000002c0002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p11&gt;,</div><div class="line">	<span class="number">0</span>xd000000000340002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p13&gt;,</div><div class="line">	<span class="number">0</span>xd0000000003c0002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p15&gt;,</div><div class="line">	<span class="number">0</span>xd000000000180002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p6&gt;,</div><div class="line">	<span class="number">0</span>xd0000000001c0002 &lt;x-coredata://<span class="number">62</span>D351B5-B043-<span class="number">4</span>AB2-B931-<span class="number">7</span>B2A2E298606/HTmCallRecordEntity/p7&gt;,</div><div class="line">);</div><div class="line">	<span class="attr">dataSourceType</span> = <span class="number">2</span>;</div><div class="line">	<span class="attr">foreignKeyAccountUserID</span> = nil;</div><div class="line">	<span class="attr">isBlackList</span> = nil;</div><div class="line">	<span class="attr">data_1</span> = nil;</div><div class="line">	<span class="attr">isLetvBindDeviceContact</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">lastConnectDate</span> = nil;</div><div class="line">	<span class="attr">abRecordID</span> = <span class="number">147</span>;</div><div class="line">	<span class="attr">etag</span> = W/<span class="string">"cf7ae8f7e49437b68597498bfddac0e2"</span>;</div><div class="line">	<span class="attr">syncStatus</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">is_voip_number</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">deviceID</span> = nil;</div><div class="line">	<span class="attr">sourceID</span> = <span class="number">0</span>A8DDD04-<span class="number">4</span>E99-<span class="number">4742</span>-B172-D48B9F43A9F0;</div><div class="line">	<span class="attr">fullSpell</span> = Aaa;</div><div class="line">	<span class="attr">remarkName</span> = nil;</div><div class="line">	<span class="attr">indexMark</span> = A;</div><div class="line">	<span class="attr">headIconPath</span> = <span class="number">0</span>A8DDD04-<span class="number">4</span>E99-<span class="number">4742</span>-B172-D48B9F43A9F0.jpeg;</div><div class="line">	<span class="attr">entityUUID</span> = <span class="number">0</span>A8DDD04-<span class="number">4</span>E99-<span class="number">4742</span>-B172-D48B9F43A9F0;</div><div class="line">	<span class="attr">nonHometimePhoneNumbers</span> = ;</div><div class="line">	<span class="attr">isShouldDelete</span> = <span class="number">0</span>;</div><div class="line">	<span class="attr">isLetvContact</span> = <span class="number">1</span>;</div><div class="line">	<span class="attr">colorHexValue</span> = <span class="number">6675144</span>;</div><div class="line">&#125;</div><div class="line">))'</div><div class="line">*** First <span class="built_in">throw</span> call stack:</div><div class="line">(<span class="number">0</span>x18203adb0 <span class="number">0</span>x18169ff80 <span class="number">0</span>x183ec5f80 <span class="number">0</span>x183ec462c <span class="number">0</span>x183ed2270 <span class="number">0</span>x183ece0e0 <span class="number">0</span>x182937f64 <span class="number">0</span>x182937a8c <span class="number">0</span>x18299cbd8 <span class="number">0</span>x183ed20e8 <span class="number">0</span>x183ef4d48 <span class="number">0</span>x100193a88 <span class="number">0</span>x100193030 <span class="number">0</span>x10014ab34 <span class="number">0</span>x100112ed8 <span class="number">0</span>x1001d1a94 <span class="number">0</span>x181f32584 <span class="number">0</span>x181f292d4 <span class="number">0</span>x1001d1230 <span class="number">0</span>x101b14b88 <span class="number">0</span>x182936e48 <span class="number">0</span>x1829f6934 <span class="number">0</span>x101b61a3c <span class="number">0</span>x101b6e554 <span class="number">0</span>x101b6572c <span class="number">0</span>x101b7066c <span class="number">0</span>x101b70364 <span class="number">0</span>x181c9d470 <span class="number">0</span>x181c9d020)</div><div class="line">libc++abi.dylib: terminating <span class="keyword">with</span> uncaught exception of type NSException</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/img/author.jpg" alt="HawkingOuYang">
          <p class="site-author-name" itemprop="name">HawkingOuYang</p>
          <p class="site-description motion-element" itemprop="description">WeApp Web iOS</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">43</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/HawkingOuYang" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/3567356/user3567356" target="_blank" title="StackOverflow">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  StackOverflow
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:Hawking.HK@gmail.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Email
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HawkingOuYang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


<!--以下3行为一条竖线和Coding Page-->
<div class="powered-by2">
    <span class="hosted-by">Hosted by
      <a href="https://pages.coding.me" style="font-weight: bold">
        Coding Pages
      </a>
    </span>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'HawkingOuYang';
      var disqus_identifier = 'page/14/index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  

  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>





<!--
注释代码

  背景动画
  <script type="text/javascript" src="/js/src/particle.js"></script>

  页面点击小红心
  <script type="text/javascript" src="/js/src/love.js"></script>

注释代码
-->


</body>
</html>